<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Event Booking</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />

    <style>
        :root {
            --primary-color: #2196F3;
            --primary-dark: #1976D2;
            --secondary-color: #FF9800;
            --success-color: #4CAF50;
            --danger-color: #F44336;
            --warning-color: #FF9800;
            --surface-color: #FFFFFF;
            --background-color: #F5F5F5;
            --text-primary: #212121;
            --text-secondary: #757575;
            --elevation-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --elevation-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            --elevation-3: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--background-color);
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* App Bar */
        .app-bar {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 1rem;
            box-shadow: var(--elevation-2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .app-title {
            font-size: 1.25rem;
            font-weight: 500;
            margin: 0;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 56px;
            height: 56px;
            background: var(--primary-color);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            box-shadow: var(--elevation-3);
            z-index: 1000;
            transition: all 0.3s ease;
        }

            .fab:hover, .fab:active {
                background: var(--primary-dark);
                transform: scale(1.1);
            }

        /* Calendar Container */
        .calendar-container {
            margin: 0.5rem;
            background: var(--surface-color);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--elevation-1);
        }

        /* Custom FullCalendar Mobile Styles */
        .fc {
            font-size: 0.8rem;
        }

        .fc-toolbar {
            padding: 0.75rem;
            background: var(--surface-color);
            border-bottom: 1px solid #E0E0E0;
            flex-wrap: wrap;
        }

        .fc-toolbar-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
            text-align: center;
        }

        .fc-button {
            background: var(--primary-color) !important;
            border: none !important;
            border-radius: 50% !important;
            width: 40px !important;
            height: 40px !important;
            padding: 0 !important;
            font-size: 1rem !important;
            box-shadow: var(--elevation-1) !important;
            margin: 0 0.25rem !important;
        }

            .fc-button:hover, .fc-button:focus {
                background: var(--primary-dark) !important;
                box-shadow: var(--elevation-2) !important;
            }

        .fc-daygrid-day {
            min-height: 65px !important;
            position: relative;
            border: 1px solid #E0E0E0 !important;
        }

        .fc-daygrid-day-number {
            padding: 6px !important;
            font-weight: 500 !important;
            color: var(--text-primary) !important;
            font-size: 0.85rem !important;
        }

        .fc-day-today .fc-daygrid-day-number {
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        /* Shift Blocks - Clean Mobile Layout */
        .shift-block {
            position: absolute;
            cursor: pointer;
            z-index: 10;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.4);
            transition: all 0.2s ease;
            min-height: 20px;
            line-height: 1;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            padding: 2px;
            overflow: hidden;
        }

            .shift-block:active {
                transform: scale(0.95);
            }

        .shift-morning {
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }

        .shift-evening {
            background: linear-gradient(135deg, #2196F3, #1565C0);
        }

        .shift-fullday {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
        }

        .shift-text {
            font-size: 0.7rem;
            font-weight: 700;
            line-height: 1;
            margin: 0;
            padding: 0;
            white-space: nowrap;
        }

        .shift-address {
            font-size: 0.6rem;
            font-weight: 500;
            line-height: 1;
            margin-top: 1px;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* Empty Shift Areas */
        .empty-shift-area {
            position: absolute;
            background: rgba(240, 240, 240, 0.8);
            border: 1px dashed #BDBDBD;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 600;
            color: #757575;
            cursor: pointer;
            transition: all 0.2s ease;
            line-height: 1;
            text-align: center;
        }

            .empty-shift-area:active {
                background: rgba(33, 150, 243, 0.15);
                border-color: var(--primary-color);
                color: var(--primary-color);
            }

        /* Modal Mobile Styles */
        .modal-dialog {
            margin: 0;
            height: 100vh;
            max-width: 100%;
        }

        .modal-content {
            height: 100vh;
            border-radius: 0;
            border: none;
        }

        .modal-header {
            background: var(--primary-color);
            color: white;
            padding: 1rem 1.5rem;
            border-bottom: none;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .btn-close {
            filter: invert(1);
        }

        .modal-body {
            padding: 1rem 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            background: var(--surface-color);
            border-top: 1px solid #E0E0E0;
            padding: 1rem 1.5rem;
        }

        /* Form Styles */
        .form-label {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #E0E0E0;
            padding: 0.75rem;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

            .form-control:focus, .form-select:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25);
            }

        /* Button Styles */
        .btn {
            border-radius: 25px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            font-size: 0.95rem;
            border: none;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: var(--primary-color);
            box-shadow: var(--elevation-1);
        }

            .btn-primary:hover, .btn-primary:active {
                background: var(--primary-dark);
                box-shadow: var(--elevation-2);
            }

        .btn-success {
            background: var(--success-color);
            box-shadow: var(--elevation-1);
        }

        .btn-danger {
            background: var(--danger-color);
            box-shadow: var(--elevation-1);
        }

        /* Quick Action Cards */
        .quick-action {
            background: var(--surface-color);
            border-radius: 12px;
            padding: 1rem;
            margin: 0.5rem;
            box-shadow: var(--elevation-1);
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

            .quick-action:active {
                background: var(--background-color);
                box-shadow: var(--elevation-2);
                transform: scale(0.98);
            }

        .quick-action-icon {
            width: 48px;
            height: 48px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            margin-right: 1rem;
        }

        /* Details Cards */
        .detail-card {
            background: var(--surface-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--elevation-1);
        }

        .detail-header {
            background: var(--primary-color);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px 8px 0 0;
            margin: -1rem -1rem 1rem -1rem;
            font-weight: 500;
        }

        /* Loader */
        .loader-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 12px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #E0E0E0;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @@keyframes spin {
            0%

        {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }

        }

        /* Error Messages */
        .error-message {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            border-left: 4px solid var(--danger-color);
        }

        /* Toast Container */
        .toast-container {
            position: fixed;
            bottom: 80px;
            left: 1rem;
            right: 1rem;
            z-index: 1100;
        }

        .toast {
            border-radius: 8px;
            box-shadow: var(--elevation-2);
            margin-bottom: 0.5rem;
        }

        /* Very Small Screens */
        @@media (max-width: 360px) {
            .fc-daygrid-day

        {
            min-height: 60px !important;
        }

        .shift-block {
            font-size: 0.65rem;
            min-height: 18px;
        }

        .shift-text {
            font-size: 0.65rem;
        }

        .shift-address {
            font-size: 0.55rem;
        }

        .empty-shift-area {
            font-size: 0.55rem;
        }

        }

        .sr-only {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }
    </style>
</head>
<body>
    <!-- App Bar -->
    <div class="app-bar">
        <h1 class="app-title">
            <i class="bi bi-calendar-event me-2"></i>
            Event Booking
        </h1>
    </div>

    <!-- Quick Actions -->
    <div class="d-flex flex-wrap p-2">
        <div class="quick-action flex-fill" onclick="refreshCalendar()">
            <div class="quick-action-icon">
                <i class="bi bi-arrow-clockwise"></i>
            </div>
            <div>
                <div class="fw-medium">Refresh</div>
                <small class="text-muted">Update calendar</small>
            </div>
        </div>
    </div>

    <!-- Calendar -->
    <div class="calendar-container position-relative">
        <div id="calendar-loader" class="loader-overlay d-none">
            <div class="spinner"></div>
        </div>
        <div id="calendar"></div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="openBookingModal()">
        <i class="bi bi-plus"></i>
    </button>

    <!-- Booking Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="modal-title-text" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-calendar-plus me-2"></i>
                        <span id="modal-title-text">New Booking</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="modal-message" class="alert d-none"></div>

                    <form id="bookingForm" novalidate>
                        <input type="hidden" id="bookingId">
                        <input type="hidden" id="userId" value="1">

                        <div class="mb-3">
                            <label for="EventName" class="form-label">Event Name *</label>
                            <input type="text" id="EventName" class="form-control" placeholder="Wedding, Birthday, etc." required>
                        </div>

                        <div class="mb-3">
                            <label for="customerName" class="form-label">Customer Name *</label>
                            <input type="text" id="customerName" class="form-control" placeholder="Enter customer name" required>
                        </div>

                        <div class="row mb-3">
                            <div class="col-8">
                                <label for="phoneNumber" class="form-label">Phone Number *</label>
                                <input type="tel" id="phoneNumber" class="form-control" placeholder="10 digit number" required>
                            </div>
                            <div class="col-4">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-outline-success w-100" onclick="openWhatsApp()">
                                    <i class="bi bi-whatsapp"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="alternativeNumber" class="form-label">Alternative Number</label>
                            <input type="tel" id="alternativeNumber" class="form-control" placeholder="Optional">
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="fromDate" class="form-label">From Date *</label>
                                <input type="date" id="fromDate" class="form-control" required>
                            </div>
                            <div class="col-6">
                                <label for="toDate" class="form-label">To Date *</label>
                                <input type="date" id="toDate" class="form-control" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="shiftType" class="form-label">Shift Type *</label>
                            <select id="shiftType" class="form-select" required>
                                <option value="morning">Morning</option>
                                <option value="evening">Evening</option>
                                <option value="fullday">Full Day</option>
                            </select>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="bookingStatus" class="form-label">Status *</label>
                                <select id="bookingStatus" class="form-select" required>
                                    <option value="Confirmed">Confirmed</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label for="paymentStatus" class="form-label">Payment *</label>
                                <select id="paymentStatus" class="form-select" required>
                                    <option value="Paid">Paid</option>
                                    <option value="Partially Paid">Partial</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-4">
                                <label for="totalAmount" class="form-label">Total ₹ *</label>
                                <input type="number" id="totalAmount" class="form-control" placeholder="0" required>
                            </div>
                            <div class="col-4">
                                <label for="advancePayment" class="form-label">Advance ₹</label>
                                <input type="number" id="advancePayment" class="form-control" placeholder="0">
                            </div>
                            <div class="col-4">
                                <label for="remainingPayment" class="form-label">Balance ₹</label>
                                <input type="number" id="remainingPayment" class="form-control" readonly>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <textarea id="address" class="form-control" rows="2" placeholder="Event location"></textarea>
                        </div>

                        <div id="dateWiseShiftContainer">
                            <!-- Dynamic shift selection will appear here -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="delete-booking" style="display:none;">
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                    <button type="button" class="btn btn-primary flex-fill" onclick="saveBooking()">
                        <i class="bi bi-save me-1"></i> Save Booking
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="details-title" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle me-2"></i>
                        <span id="details-title">Booking Details</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="booking-details-content">
                    <!-- Booking details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success me-2" id="whatsapp-btn">
                        <i class="bi bi-whatsapp me-1"></i> WhatsApp
                    </button>
                    <button type="button" class="btn btn-primary flex-fill" id="edit-booking-btn">
                        <i class="bi bi-pencil me-1"></i> Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Multi-booking Modal -->
    <div class="modal fade" id="multiBookingModal" tabindex="-1" aria-labelledby="multiBookingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="multiBookingModalLabel">
                        <i class="bi bi-list me-2"></i>
                        Multiple Bookings
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="multi-booking-content">
                    <!-- Multiple booking options will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <script>
        // Simple, working event booking calendar
        let shiftMap = {};
        let calendar;
        const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
        const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
        const multiBookingModal = new bootstrap.Modal(document.getElementById('multiBookingModal'));

        // Utility functions
        function localYMD(date) {
            const Y = date.getFullYear();
            const M = String(date.getMonth() + 1).padStart(2, '0');
            const D = String(date.getDate()).padStart(2, '0');
            return `${Y}-${M}-${D}`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '—';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function showToast(message, type = 'info') {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
            toast.innerHTML = `${message} <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>`;
            document.body.appendChild(toast);
            setTimeout(() => {
                if (toast.parentNode) toast.parentNode.removeChild(toast);
            }, 3000);
        }

        function showLoader() {
            document.getElementById('calendar-loader').classList.remove('d-none');
        }

        function hideLoader() {
            document.getElementById('calendar-loader').classList.add('d-none');
        }

        // Create shift blocks
        function createShiftBlock(shiftType, bookings, dateStr) {
            const div = document.createElement('div');
            div.className = `shift-block shift-${shiftType.replace(' ', '')}`;

            const label = document.createElement('div');
            label.className = 'shift-text';
            label.textContent = shiftType.toUpperCase();
            div.appendChild(label);

            if (bookings[0] && bookings[0].fullBookingData && bookings[0].fullBookingData.address) {
                const addr = document.createElement('div');
                addr.className = 'shift-address';
                const shortAddress = bookings[0].fullBookingData.address.split(' ')[0];
                addr.textContent = shortAddress.length > 8 ? shortAddress.substring(0, 8) + '...' : shortAddress;
                div.appendChild(addr);
            }

            div.onclick = function(e) {
                e.stopPropagation();
                if (bookings.length === 1) {
                    viewBookingDetails(bookings[0].fullBookingData);
                } else {
                    showMultipleBookings(dateStr, bookings);
                }
            };

            return div;
        }

        function addEmptyShiftArea(cell, shiftType, dateStr) {
            const area = document.createElement('div');
            area.className = 'empty-shift-area';

            const position = shiftType === 'morning' ?
                { top: '26px', height: '30%', left: '3px', right: '3px' } :
                { bottom: '3px', height: '30%', left: '3px', right: '3px' };

            Object.assign(area.style, position);

            const text = document.createElement('span');
            text.textContent = shiftType === 'morning' ? '+ MORN' : '+ EVE';
            area.appendChild(text);

            area.onclick = function(e) {
                e.stopPropagation();
                openBookingModal(dateStr, [shiftType]);
            };

            cell.appendChild(area);
        }

        // Render shift blocks
        function renderShiftBlocks(arg) {
            const dateStr = localYMD(arg.date);
            const shifts = shiftMap[dateStr] || [];

            if (!shifts.length) return;

            const cell = arg.el;
            cell.style.position = 'relative';

            const POSITIONS = {
                'full day': { top: '26px', height: 'calc(100% - 30px)', left: '3px', right: '3px' },
                'morning': { top: '26px', height: '30%', left: '3px', right: '3px' },
                'evening': { bottom: '3px', height: '30%', left: '3px', right: '3px' }
            };

            const byType = shifts.reduce((acc, s) => {
                (acc[s.shift] = acc[s.shift] || []).push(s);
                return acc;
            }, {});

            const hasFull = byType['full day'];
            const hasMorn = byType['morning'];
            const hasEven = byType['evening'];

            if (!hasFull && (hasMorn || hasEven)) {
                if (hasMorn && !hasEven) {
                    addEmptyShiftArea(cell, 'evening', dateStr);
                } else if (!hasMorn && hasEven) {
                    addEmptyShiftArea(cell, 'morning', dateStr);
                }
            }

            Object.entries(byType).forEach(([type, list]) => {
                const block = createShiftBlock(type, list, dateStr);
                Object.assign(block.style, POSITIONS[type]);
                cell.appendChild(block);
            });
        }

        // Handle date clicks
        function handleDateClick(dateStr) {
            const shifts = shiftMap[dateStr] || [];
            const bookedShiftTypes = shifts.map(s => s.shift);

            if (bookedShiftTypes.includes('full day')) {
                if (shifts.length === 1) {
                    viewBookingDetails(shifts[0].fullBookingData);
                } else {
                    showMultipleBookings(dateStr, shifts);
                }
                return;
            }

            if (shifts.length === 0) {
                openBookingModal(dateStr);
                return;
            }

            const hasMorning = bookedShiftTypes.includes('morning');
            const hasEvening = bookedShiftTypes.includes('evening');

            if (hasMorning && hasEvening) {
                showMultipleBookings(dateStr, shifts);
            } else if (hasMorning && !hasEvening) {
                showPartialBookingOptions(dateStr, shifts, ['evening']);
            } else if (!hasMorning && hasEvening) {
                showPartialBookingOptions(dateStr, shifts, ['morning']);
            } else {
                openBookingModal(dateStr);
            }
        }

        function showPartialBookingOptions(dateStr, existingBookings, availableShifts) {
            const formattedDate = formatDate(dateStr);

            let content = `
                <div class="mb-3">
                    <h6 class="text-muted">Date: ${formattedDate}</h6>
                    <p class="small">This date has partial bookings. Choose an option:</p>
                </div>
                <div class="mb-3">
                    <h6 class="text-primary">Existing Bookings:</h6>`;

            existingBookings.forEach((booking, index) => {
                const data = booking.fullBookingData;
                content += `
                    <div class="detail-card mb-2" onclick="selectExistingBooking(${index})" style="cursor: pointer;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${data.eventName || 'Event'}</strong>
                                <br><small class="text-muted">${data.customerName || 'Customer'}</small>
                            </div>
                            <span class="badge bg-primary">${capitalizeFirstLetter(booking.shift)}</span>
                        </div>
                    </div>
                `;
            });

            content += `</div>`;

            if (availableShifts.length > 0) {
                content += `<div class="mb-3">
                    <h6 class="text-success">Available Shifts:</h6>`;

                availableShifts.forEach(shift => {
                    content += `
                        <button class="btn btn-outline-success btn-sm me-2 mb-2"
                                onclick="bookAvailableShift('${dateStr}', '${shift}')">
                            <i class="bi bi-plus-circle me-1"></i>
                            Book ${capitalizeFirstLetter(shift)}
                        </button>
                    `;
                });
                content += `</div>`;
            }

            document.getElementById('multi-booking-content').innerHTML = content;
            window._existingBookings = existingBookings;
            multiBookingModal.show();
        }

        window.selectExistingBooking = function(index) {
            multiBookingModal.hide();
            const booking = window._existingBookings[index];
            viewBookingDetails(booking.fullBookingData);
        };

        window.bookAvailableShift = function(dateStr, shift) {
            multiBookingModal.hide();
            openBookingModal(dateStr, [shift]);
        };

        function showMultipleBookings(dateStr, bookings) {
            let content = `
                <div class="mb-3">
                    <h6 class="text-muted">Date: ${formatDate(dateStr)}</h6>
                </div>
            `;

            bookings.forEach((booking, index) => {
                const data = booking.fullBookingData;
                content += `
                    <div class="detail-card" onclick="selectBooking(${index})" style="cursor: pointer;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${data.eventName || 'Event'}</h6>
                                <p class="mb-1 text-muted">${data.customerName || 'Customer'}</p>
                                <small class="text-muted">
                                    <i class="bi bi-telephone me-1"></i>
                                    ${data.phoneNumber || 'No phone'}
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary">${capitalizeFirstLetter(booking.shift)}</span>
                                <br><small class="text-muted">₹${data.totalAmount || 0}</small>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('multi-booking-content').innerHTML = content;
            window._multiBookingData = bookings;
            multiBookingModal.show();
        }

        window.selectBooking = function(index) {
            multiBookingModal.hide();
            const booking = window._multiBookingData[index];
            viewBookingDetails(booking.fullBookingData);
        };

        // Load events from server
        function loadEvents() {
            showLoader();

            $.ajax({
                url: '/EventBooking/GetAllEventBookings',
                type: 'GET'
            }).done(function(bookings) {
                shiftMap = {};
                const bgEvents = [];

                bookings.forEach(function(booking) {
                    const from = booking.fromDate ? new Date(booking.fromDate) : new Date(booking.createdDate);
                    const to = booking.toDate ? new Date(booking.toDate) : from;

                    from.setHours(0, 0, 0, 0);
                    to.setHours(0, 0, 0, 0);

                    const parsedShifts = booking.dateWiseShifts ? JSON.parse(booking.dateWiseShifts) : {};
                    const defaultShift = booking.shiftType ? [booking.shiftType.toLowerCase()] : ['full day'];

                    for (let d = new Date(from); d <= to; d.setDate(d.getDate() + 1)) {
                        const key = localYMD(d);
                        const dayShifts = parsedShifts[key] || defaultShift;

                        dayShifts.forEach(function(item) {
                            const shiftName = (typeof item === 'string' ? item : item.shift).toLowerCase();
                            if (['morning', 'evening', 'full day'].includes(shiftName)) {
                                shiftMap[key] = shiftMap[key] || [];
                                shiftMap[key].push({
                                    shift: shiftName,
                                    fullBookingData: booking
                                });
                            }
                        });
                    }

                    const bgStart = new Date(from);
                    const bgEnd = new Date(to);
                    bgEnd.setDate(bgEnd.getDate() + 1);

                    bgEvents.push({
                        id: booking.bookingId,
                        title: booking.customerName || '',
                        start: localYMD(bgStart),
                        end: localYMD(bgEnd),
                        display: 'background',
                        backgroundColor: 'transparent'
                    });
                });

                calendar.removeAllEvents();
                bgEvents.forEach(e => calendar.addEvent(e));
                hideLoader();

            }).fail(function() {
                showToast('Failed to load bookings', 'error');
                hideLoader();
            });
        }

        // Calendar initialization
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 'auto',
                headerToolbar: {
                    left: 'prev',
                    center: 'title',
                    right: 'next'
                },

                dateClick(info) {
                    const target = info.jsEvent.target;
                    const isShiftBlock = target.closest('.shift-block');
                    const isEmptyArea = target.closest('.empty-shift-area');

                    if (!isShiftBlock && !isEmptyArea) {
                        handleDateClick(info.dateStr);
                    }
                },

                dayCellDidMount(arg) {
                    renderShiftBlocks(arg);
                },

                datesSet() {
                    loadEvents();
                }
            });

            calendar.render();
        }

        // Booking modal functions
        window.openBookingModal = function(dateStr = '', availableShifts = null) {
            resetBookingForm();

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fromDate').value = dateStr || today;
            document.getElementById('toDate').value = dateStr || today;

            if (availableShifts) {
                const shiftSelect = document.getElementById('shiftType');
                Array.from(shiftSelect.options).forEach(option => {
                    option.disabled = !availableShifts.includes(option.value);
                });
                if (availableShifts.length > 0) {
                    shiftSelect.value = availableShifts[0];
                }
            }

            document.getElementById('modal-title-text').textContent = 'New Booking';
            document.getElementById('delete-booking').style.display = 'none';
            bookingModal.show();
        };

        function resetBookingForm() {
            document.getElementById('bookingForm').reset();
            document.getElementById('bookingId').value = '';
            document.getElementById('userId').value = '1';
            document.querySelectorAll('.error-message').forEach(el => el.remove());
            document.getElementById('modal-message').classList.add('d-none');
        }

        function calculateRemainingPayment() {
            const total = parseFloat(document.getElementById('totalAmount').value) || 0;
            const advance = parseFloat(document.getElementById('advancePayment').value) || 0;
            const remaining = total - advance;

            document.getElementById('remainingPayment').value = remaining.toFixed(2);

            const paymentStatus = document.getElementById('paymentStatus');
            if (total === 0) {
                paymentStatus.value = 'Pending';
            } else if (remaining <= 0) {
                paymentStatus.value = 'Paid';
            } else if (advance > 0) {
                paymentStatus.value = 'Partially Paid';
            } else {
                paymentStatus.value = 'Pending';
            }
        }

        window.saveBooking = function() {
            if (!validateForm()) return;

            const formData = {
                bookingId: document.getElementById('bookingId').value || 0,
                userId: document.getElementById('userId').value || 1,
                EventName: document.getElementById('EventName').value,
                customerName: document.getElementById('customerName').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                alternativeNumber: document.getElementById('alternativeNumber').value,
                fromDate: document.getElementById('fromDate').value,
                toDate: document.getElementById('toDate').value,
                shiftType: document.getElementById('shiftType').value,
                bookingStatus: document.getElementById('bookingStatus').value,
                paymentStatus: document.getElementById('paymentStatus').value,
                totalAmount: parseFloat(document.getElementById('totalAmount').value) || 0,
                advancePayment: parseFloat(document.getElementById('advancePayment').value) || 0,
                remainingPayment: parseFloat(document.getElementById('remainingPayment').value) || 0,
                address: document.getElementById('address').value
            };

            const messageEl = document.getElementById('modal-message');
            messageEl.className = 'alert alert-info';
            messageEl.textContent = 'Saving booking...';
            messageEl.classList.remove('d-none');

            $.ajax({
                url: '/EventBooking/AddOrUpdateEventBooking',
                type: 'POST',
                data: { eventBooking: formData },
                success: function(response) {
                    if (response.success) {
                        showToast('Booking saved successfully!', 'success');
                        bookingModal.hide();
                        loadEvents();
                    } else {
                        messageEl.className = 'alert alert-danger';
                        messageEl.textContent = response.message || 'Error saving booking';
                    }
                },
                error: function() {
                    messageEl.className = 'alert alert-danger';
                    messageEl.textContent = 'Failed to save booking. Please try again.';
                }
            });
        };

        function validateForm() {
            document.querySelectorAll('.error-message').forEach(el => el.remove());
            let isValid = true;

            const requiredFields = [
                { id: 'EventName', name: 'Event Name' },
                { id: 'customerName', name: 'Customer Name' },
                { id: 'phoneNumber', name: 'Phone Number' },
                { id: 'fromDate', name: 'From Date' },
                { id: 'toDate', name: 'To Date' },
                { id: 'totalAmount', name: 'Total Amount' }
            ];

            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (!element.value.trim()) {
                    const error = document.createElement('div');
                    error.className = 'error-message';
                    error.textContent = `${field.name} is required`;
                    element.parentNode.insertBefore(error, element.nextSibling);
                    isValid = false;
                }
            });

            const phone = document.getElementById('phoneNumber').value.trim();
            if (phone && !/^\d{10}$/.test(phone)) {
                const error = document.createElement('div');
                error.className = 'error-message';
                error.textContent = 'Please enter a valid 10-digit phone number';
                document.getElementById('phoneNumber').parentNode.appendChild(error);
                isValid = false;
            }

            return isValid;
        }

        function viewBookingDetails(booking) {
            const content = `
                <div class="detail-card">
                    <div class="detail-header">
                        <i class="bi bi-calendar-event me-2"></i>Event Details
                    </div>
                    <div class="row mb-2">
                        <div class="col-5 fw-medium">Event:</div>
                        <div class="col-7">${booking.eventName || '—'}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-5 fw-medium">Duration:</div>
                        <div class="col-7">${formatDate(booking.fromDate)} to ${formatDate(booking.toDate)}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-5 fw-medium">Shift:</div>
                        <div class="col-7">${capitalizeFirstLetter(booking.shiftType)}</div>
                    </div>
                </div>

                <div class="detail-card">
                    <div class="detail-header">
                        <i class="bi bi-person me-2"></i>Customer Info
                    </div>
                    <div class="row mb-2">
                        <div class="col-5 fw-medium">Name:</div>
                        <div class="col-7">${booking.customerName || '—'}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-5 fw-medium">Phone:</div>
                        <div class="col-7">
                            <a href="tel:${booking.phoneNumber}" class="text-decoration-none">
                                ${booking.phoneNumber || '—'}
                            </a>
                        </div>
                    </div>
                    ${booking.address ? `
                    <div class="row">
                        <div class="col-5 fw-medium">Address:</div>
                        <div class="col-7">${booking.address}</div>
                    </div>
                    ` : ''}
                </div>

                <div class="detail-card">
                    <div class="detail-header">
                        <i class="bi bi-currency-rupee me-2"></i>Payment Details
                    </div>
                    <div class="row mb-2">
                        <div class="col-5 fw-medium">Total:</div>
                        <div class="col-7">₹${(booking.totalAmount || 0).toFixed(2)}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-5 fw-medium">Advance:</div>
                        <div class="col-7">₹${(booking.advancePayment || 0).toFixed(2)}</div>
                    </div>
                    <div class="row">
                        <div class="col-5 fw-medium">Balance:</div>
                        <div class="col-7">₹${(booking.remainingPayment || 0).toFixed(2)}</div>
                    </div>
                </div>
            `;

            document.getElementById('booking-details-content').innerHTML = content;
            document.getElementById('details-title').textContent = booking.eventName || 'Booking Details';

            document.getElementById('edit-booking-btn').onclick = function() {
                detailsModal.hide();
                openBookingModalForEdit(booking);
            };

            document.getElementById('whatsapp-btn').onclick = function() {
                sendWhatsAppMessage(booking);
            };

            detailsModal.show();
        }

        function openBookingModalForEdit(bookingData) {
            resetBookingForm();

            document.getElementById('modal-title-text').textContent = 'Edit Booking';
            document.getElementById('delete-booking').style.display = 'block';

            document.getElementById('bookingId').value = bookingData.bookingId;
            document.getElementById('EventName').value = bookingData.eventName || '';
            document.getElementById('customerName').value = bookingData.customerName || '';
            document.getElementById('phoneNumber').value = bookingData.phoneNumber || '';
            document.getElementById('alternativeNumber').value = bookingData.alternativeNumber || '';
            document.getElementById('fromDate').value = bookingData.fromDate ? bookingData.fromDate.split('T')[0] : '';
            document.getElementById('toDate').value = bookingData.toDate ? bookingData.toDate.split('T')[0] : '';
            document.getElementById('shiftType').value = bookingData.shiftType || 'morning';
            document.getElementById('bookingStatus').value = bookingData.bookingStatus || 'Confirmed';
            document.getElementById('paymentStatus').value = bookingData.paymentStatus || 'Pending';
            document.getElementById('totalAmount').value = bookingData.totalAmount || '';
            document.getElementById('advancePayment').value = bookingData.advancePayment || '';
            document.getElementById('address').value = bookingData.address || '';

            calculateRemainingPayment();
            bookingModal.show();
        }

        function sendWhatsAppMessage(booking) {
            const phone = booking.phoneNumber?.replace(/\D/g, '');
            if (!phone) {
                showToast('No phone number available', 'error');
                return;
            }

            const message = `Hello ${booking.customerName || 'Customer'}! Your booking for "${booking.eventName}" on ${formatDate(booking.fromDate)} has been confirmed. Thank you for choosing our services!`;

            const url = `https://wa.me/91${phone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            showToast('Opening WhatsApp...', 'success');
        }

        window.refreshCalendar = function() {
            loadEvents();
            showToast('Calendar refreshed', 'success');
        };

        window.openWhatsApp = function() {
            const phone = document.getElementById('phoneNumber').value.replace(/\D/g, '');
            if (!phone) {
                showToast('Please enter phone number first', 'error');
                return;
            }

            const url = `https://wa.me/91${phone}`;
            window.open(url, '_blank');
        };

        // Event handlers
        document.getElementById('advancePayment').addEventListener('input', calculateRemainingPayment);
        document.getElementById('totalAmount').addEventListener('input', calculateRemainingPayment);

        document.getElementById('delete-booking').addEventListener('click', function() {
            const bookingId = document.getElementById('bookingId').value;
            if (!bookingId) return;

            if (!confirm('Are you sure you want to delete this booking?')) return;

            $.ajax({
                url: `/EventBooking/Delete/${bookingId}`,
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        showToast('Booking deleted successfully', 'success');
                        bookingModal.hide();
                        loadEvents();
                    } else {
                        showToast('Failed to delete booking', 'error');
                    }
                },
                error: function() {
                    showToast('Failed to delete booking', 'error');
                }
            });
        });

        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveBooking();
        });

        // Initialize calendar when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCalendar();
            loadEvents();
        });
    </script>
</body>
</html>