<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Event Booking Calendar</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- jQuery UI CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- Enhanced Mobile-Responsive Styles -->
    <style>
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-radius: 8px;
            --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --shadow-md: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
        }

        body, html {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.5;
        }

        .container-fluid {
            padding: 0 !important;
        }

        /* Header Section - Mobile Optimized */
        .header-section {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 1rem;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

            .header-section h1 {
                font-size: 1.5rem;
                font-weight: 600;
                margin-bottom: 1rem;
                text-align: center;
            }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            flex-wrap: wrap;
        }

            .action-buttons .btn {
                flex: 1;
                min-width: 140px;
                font-size: 0.9rem;
                padding: 0.75rem 1rem;
                border-radius: var(--border-radius);
                border: 2px solid transparent;
                transition: var(--transition);
                font-weight: 500;
            }

            .action-buttons .btn-primary {
                background: white;
                color: var(--primary-color);
                border-color: white;
            }

                .action-buttons .btn-primary:hover {
                    background: var(--light-color);
                    transform: translateY(-2px);
                }

            .action-buttons .btn-outline-secondary {
                border-color: white;
                color: white;
            }

                .action-buttons .btn-outline-secondary:hover {
                    background: white;
                    color: var(--primary-color);
                    transform: translateY(-2px);
                }

        /* Calendar Container */
        .calendar-container {
            padding: 1rem;
            background: var(--light-color);
            min-height: calc(100vh - 140px);
        }

        .calendar-wrapper {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            padding: 1rem;
            margin-bottom: 2rem;
        }

        /* FullCalendar Mobile Optimizations */
        .fc {
            font-size: 0.85rem;
        }

        .fc-header-toolbar {
            flex-direction: column;
            gap: 0.75rem;
            padding: 0.5rem 0;
        }

        .fc-toolbar-chunk {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .fc-button {
            padding: 0.5rem 0.75rem !important;
            font-size: 0.8rem !important;
            border-radius: 6px !important;
            border: none !important;
            box-shadow: var(--shadow-sm) !important;
            transition: var(--transition) !important;
        }

            .fc-button:hover {
                transform: translateY(-1px) !important;
                box-shadow: var(--shadow-md) !important;
            }

        .fc-button-primary {
            background-color: var(--primary-color) !important;
        }

        .fc-today-button {
            background-color: var(--success-color) !important;
        }

        .fc-title-center h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .fc-daygrid-event {
            font-size: 0.7rem;
            padding: 2px 4px;
            border-radius: 4px;
            margin: 1px 0;
        }

        .fc-daygrid-day {
            min-height: 120px;
        }

        .fc-daygrid-day-number {
            padding: 4px;
            font-weight: 500;
        }

        /* Enhanced Shift Blocks - Improved for better visibility */
        .shift-block {
            position: absolute;
            cursor: pointer;
            z-index: 10;
            border-radius: 6px;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 35px;
            box-shadow: var(--shadow-sm);
            padding: 4px 6px;
            font-size: 0.75rem;
            line-height: 1.2;
        }

            .shift-block:hover {
                transform: scale(1.02);
                box-shadow: var(--shadow-md);
            }

        .shift-label {
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            pointer-events: none;
            line-height: 1.1;
            margin-bottom: 2px;
        }

        .shift-customer {
            color: white;
            font-size: 0.65rem;
            font-weight: 500;
            text-align: center;
            pointer-events: none;
            line-height: 1.1;
            margin-bottom: 1px;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .shift-address {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.6rem;
            font-weight: 400;
            text-align: center;
            pointer-events: none;
            line-height: 1.1;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .empty-shift-area {
            transition: var(--transition);
            font-size: 0.7rem;
            border-radius: 4px;
        }

            .empty-shift-area:hover {
                background-color: rgba(240,240,240,0.7) !important;
                border-color: var(--primary-color) !important;
            }

        .empty-shift-text {
            font-size: 0.65rem;
            color: rgba(0,0,0,0.6);
            font-weight: 600;
            text-align: center;
            line-height: 1.2;
        }

        /* Enhanced Touch and Click Effects */
        .touchable-element {
            transition: all 0.15s ease;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .touch-pressed {
            transform: scale(0.95);
            opacity: 0.8;
        }

        .touch-clicked,
        .click-animation {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .hover-effect:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Enhanced Modal Styles */
        .modal-dialog-scrollable .modal-content {
            max-height: 90vh;
        }

        .date-info {
            border-left: 4px solid var(--primary-color);
        }

        .shift-action-btn {
            transition: all 0.2s ease;
            border-width: 2px;
        }

            .shift-action-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            .shift-action-btn:active {
                transform: translateY(0);
            }

            .shift-action-btn:disabled {
                transform: none;
                opacity: 0.6;
            }

        /* Modal Enhancements */
        .modal-dialog {
            margin: 0.5rem;
            max-width: calc(100vw - 1rem);
        }

        .modal-content {
            border-radius: var(--border-radius);
            border: none;
            box-shadow: var(--shadow-md);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #0056b3 100%);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            padding: 1rem 1.5rem;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .btn-close {
            filter: invert(1);
            opacity: 0.8;
        }

            .btn-close:hover {
                opacity: 1;
            }

        .modal-body {
            padding: 1.5rem;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #dee2e6;
            background: var(--light-color);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        /* Form Enhancements */
        .form-label {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-control, .form-select {
            border-radius: 6px;
            border: 2px solid #e9ecef;
            padding: 0.75rem;
            font-size: 0.9rem;
            transition: var(--transition);
            min-height: 44px; /* Touch-friendly */
        }

            .form-control:focus, .form-select:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
                transform: translateY(-1px);
            }

            .form-control:invalid {
                border-color: var(--danger-color);
            }

        /* Enhanced Button Styles */
        .btn {
            border-radius: 6px;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            transition: var(--transition);
            min-height: 44px;
            border: 2px solid transparent;
        }

            .btn:hover {
                transform: translateY(-1px);
                box-shadow: var(--shadow-md);
            }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #0056b3 100%);
            border-color: var(--primary-color);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #1e7e34 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #c82333 100%);
        }

        /* Card Enhancements */
        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1rem;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #0056b3 100%);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            padding: 0.75rem 1rem;
        }

        .card-body {
            padding: 1rem;
        }

        /* Alert Enhancements */
        .alert {
            border-radius: 6px;
            border: none;
            box-shadow: var(--shadow-sm);
            margin-bottom: 1rem;
        }

        /* Shift Selection and Time Inputs */
        .shifts-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .shift-row {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 0.5rem;
        }

        .shift-container {
            margin-bottom: 1rem;
        }

        .time-selection {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: var(--light-color);
            border-radius: 6px;
        }

        .time-inputs {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

            .time-inputs .input-group {
                min-width: 120px;
                flex: 1;
            }

        .input-group-text {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Booking Details List */
        .booking-details .list-group-item {
            border: none;
            border-bottom: 1px solid #e9ecef;
            padding: 0.75rem 0;
        }

        .booking-details .row {
            align-items: center;
        }

        .booking-details .fw-bold {
            color: var(--dark-color);
            font-size: 0.9rem;
        }

        /* Loading Spinner */
        #calendar-loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

            #calendar-loader.show {
                display: flex;
            }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1055;
        }

        .toast {
            border-radius: 6px;
            box-shadow: var(--shadow-md);
        }

        /* Error Messages */
        .error-message {
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        /* Badge Enhancements */
        .badge {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
        }

        /* Responsive Breakpoints */
        @@media (max-width: 576px) {
            .header-section

        {
            padding: 0.75rem;
        }

        .header-section h1 {
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
        }

        .action-buttons {
            flex-direction: column;
        }

            .action-buttons .btn {
                min-width: unset;
                flex: none;
            }

        .calendar-container {
            padding: 0.75rem;
        }

        .calendar-wrapper {
            padding: 0.75rem;
        }

        .fc-header-toolbar {
            padding: 0.25rem 0;
        }

        .fc-title-center h2 {
            font-size: 1rem;
        }

        .fc-button {
            padding: 0.4rem 0.6rem !important;
            font-size: 0.75rem !important;
        }

        .fc-daygrid-day {
            min-height: 100px;
        }

        .modal-dialog {
            margin: 0;
            max-width: 100vw;
            height: 100vh;
            max-height: 100vh;
        }

        .modal-content {
            height: 100vh;
            border-radius: 0;
        }

        .modal-header,
        .modal-footer {
            border-radius: 0;
        }

        .modal-body {
            padding: 1rem;
            max-height: calc(100vh - 160px);
        }

        .modal-footer {
            padding: 1rem;
            gap: 0.5rem;
        }

            .modal-footer .btn {
                flex: 1;
                min-width: 0;
            }

        .time-inputs {
            flex-direction: column;
            align-items: stretch;
        }

            .time-inputs .input-group {
                min-width: unset;
            }

        }

        @@media (min-width: 577px) and (max-width: 768px) {
            .action-buttons

        {
            justify-content: center;
        }

        .action-buttons .btn {
            flex: 0 1 auto;
            min-width: 140px;
        }

        .modal-dialog {
            max-width: 90vw;
        }

        }

        @@media (min-width: 769px) {
            .header-section h1

        {
            text-align: left;
        }

        .action-buttons {
            justify-content: flex-start;
        }

            .action-buttons .btn {
                flex: 0 1 auto;
            }

        .modal-dialog {
            max-width: 800px;
            margin: 1.75rem auto;
        }

        .time-inputs {
            justify-content: flex-start;
        }

        .fc-daygrid-day {
            min-height: 140px;
        }

        }

        /* Dark mode support */
        @@media (prefers-color-scheme: dark) {
            : root

        {
            --light-color: #2c3e50;
            --dark-color: #ecf0f1;
        }

        body {
            background-color: #34495e;
            color: #ecf0f1;
        }

        .calendar-wrapper,
        .modal-content,
        .card {
            background-color: #2c3e50;
            color: #ecf0f1;
        }

        }

        /* High contrast mode */
        @@media (prefers-contrast: high) {
            .btn, .form-control, .form-select

        {
            border-width: 3px;
        }

        }

        /* Reduced motion */
        @@media (prefers-reduced-motion: reduce) {
            *, *::before, *::after

        {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }

        }

        /* Print styles */
        @@media print {
            .header-section, .action-buttons, .modal, #calendar-loader

        {
            display: none !important;
        }

        .calendar-container {
            padding: 0;
        }

        .calendar-wrapper {
            box-shadow: none;
            border: 1px solid #000;
        }

        }

        /* Focus improvements for accessibility */
        .btn:focus,
        .form-control:focus,
        .form-select:focus {
            outline: 3px solid rgba(0, 123, 255, 0.5);
            outline-offset: 2px;
        }

        /* Prevent iOS zoom on input focus */
        @@supports (-webkit-overflow-scrolling: touch) {
            input [type="text"], input[type="email"], input[type="tel"], input[type="number"], input[type="date"], input[type="time"], select, textarea

        {
            font-size: 16px;
        }

        }

        /* Custom scrollbar for webkit browsers */
        .modal-body::-webkit-scrollbar,
        .shifts-container::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track,
        .shifts-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb,
        .shifts-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

            .modal-body::-webkit-scrollbar-thumb:hover,
            .shifts-container::-webkit-scrollbar-thumb:hover {
                background: #a8a8a8;
            }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Enhanced Header -->
        <div class="header-section">
            <h1><i class="bi bi-calendar-event me-2"></i>Event Booking Calendar</h1>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="open-booking-modal"
                        class="btn btn-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#bookingModal">
                    <i class="bi bi-plus-circle me-2"></i>New Booking
                </button>
                <button id="fetch-bookings" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-clockwise me-2"></i>Refresh Calendar
                </button>
            </div>
        </div>

        <!-- Alert Messages Container -->
        <div id="message-container"></div>

        <!-- Loading Spinner -->
        <div id="calendar-loader" class="d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Enhanced Calendar Container -->
        <div class="calendar-container">
            <div class="calendar-wrapper">
                <div id="calendar"></div>
            </div>
        </div>
    </div>

    <!-- Enhanced New/Edit Booking Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookingModalLabel">
                        <i class="bi bi-calendar-plus me-2"></i>Add New Booking
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="modal-message" class="alert d-none"></div>

                    <form id="bookingFormFields" novalidate>
                        <input type="hidden" id="bookingId">
                        <input type="hidden" id="userId" value="1">
                        <input type="hidden" id="createdDate">

                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <label for="EventName" class="form-label">
                                    <i class="bi bi-calendar-event me-1"></i>Event Name
                                </label>
                                <input type="text" id="EventName" class="form-control" placeholder="Enter event name" required>
                            </div>
                            <div class="col-12 col-md-6">
                                <label for="customerName" class="form-label">
                                    <i class="bi bi-person me-1"></i>Customer Name
                                </label>
                                <input type="text" id="customerName" class="form-control" placeholder="Enter customer name" required>
                            </div>
                            <div class="col-12 col-md-6">
                                <label for="phoneNumber" class="form-label">
                                    <i class="bi bi-telephone me-1"></i>Phone Number
                                </label>
                                <input type="tel" id="phoneNumber" class="form-control" placeholder="Enter phone number" required>
                            </div>
                            <div class="col-12 col-md-6">
                                <label for="alternativeNumber" class="form-label">
                                    <i class="bi bi-telephone-plus me-1"></i>Alternative Number
                                </label>
                                <input type="tel" id="alternativeNumber" class="form-control" placeholder="Enter alternative number">
                            </div>
                            <div class="col-12 col-md-6">
                                <label for="fromDate" class="form-label">
                                    <i class="bi bi-calendar-date me-1"></i>From Date
                                </label>
                                <input type="date" id="fromDate" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6">
                                <label for="toDate" class="form-label">
                                    <i class="bi bi-calendar-date me-1"></i>To Date
                                </label>
                                <input type="date" id="toDate" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6">
                                <label for="shiftType" class="form-label">
                                    <i class="bi bi-clock me-1"></i>Shift Type
                                </label>
                                <select id="shiftType" class="form-select" required>
                                    <option value="morning" selected>Morning</option>
                                    <option value="evening">Evening</option>
                                    <option value="fullday">Full Day</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-6">
                                <label for="bookingStatus" class="form-label">
                                    <i class="bi bi-check-circle me-1"></i>Booking Status
                                </label>
                                <select id="bookingStatus" class="form-select" required>
                                    <option value="Confirmed" selected>Confirmed</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-4">
                                <label for="totalAmount" class="form-label">
                                    <i class="bi bi-currency-rupee me-1"></i>Total Amount
                                </label>
                                <input type="number" id="totalAmount" class="form-control" placeholder="0.00" required>
                            </div>
                            <div class="col-12 col-md-4">
                                <label for="advancePayment" class="form-label">
                                    <i class="bi bi-credit-card me-1"></i>Advance Payment
                                </label>
                                <input type="number" id="advancePayment" class="form-control" placeholder="0.00">
                            </div>
                            <div class="col-12 col-md-4">
                                <label for="remainingPayment" class="form-label">
                                    <i class="bi bi-cash me-1"></i>Remaining Payment
                                </label>
                                <input type="number" id="remainingPayment" class="form-control" readonly>
                            </div>
                            <div class="col-12 col-md-6">
                                <label for="paymentStatus" class="form-label">
                                    <i class="bi bi-credit-card-2-front me-1"></i>Payment Status
                                </label>
                                <select id="paymentStatus" class="form-select" required>
                                    <option value="Paid">Paid</option>
                                    <option value="Partially Paid">Partially Paid</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="address" class="form-label">
                                    <i class="bi bi-geo-alt me-1"></i>Address
                                </label>
                                <textarea id="address" class="form-control" rows="3" placeholder="Enter event address"></textarea>
                            </div>
                            <div class="col-12" id="dateWiseShiftContainer">
                                <!-- Dynamic shift fields will be added here -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="saveBooking()" id="save-booking" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i>Save Booking
                    </button>
                    <button type="button" id="delete-booking" class="btn btn-danger d-none">
                        <i class="bi bi-trash me-1"></i>Delete
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Booking Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalLabel">
                        <i class="bi bi-card-list me-2"></i>Booking Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="detailError" class="alert alert-danger d-none"></div>
                    <div class="booking-details">
                        <!-- Details will be injected here by JS -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="edit-from-details" class="btn btn-primary">
                        <i class="bi bi-pencil me-1"></i>Edit
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Multi-Booking Selection Modal -->
    <div class="modal fade" id="multiBookingModal" tabindex="-1" aria-labelledby="multiBookingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="multiBookingModalLabel">
                        <i class="bi bi-list me-2"></i>Multiple Bookings Found
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="multiBookingBody">
                    <!-- Dynamically injected list of bookings -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- jQuery UI -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <!-- Select2 -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function() {
            // ─────────────────────────────────────────────────────────────────────────────
            // 1. GLOBAL VARIABLES & UTILITIES
            // ─────────────────────────────────────────────────────────────────────────────
            let shiftMap = {};
            const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
            const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
            const multiBookingModal = new bootstrap.Modal(document.getElementById('multiBookingModal'));

            // Mobile touch detection
            let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            // Format a Date in LOCAL YYYY-MM-DD
            function localYMD(d) {
                const Y = d.getFullYear();
                const M = String(d.getMonth() + 1).padStart(2, '0');
                const D = String(d.getDate()).padStart(2, '0');
                return `${Y}-${M}-${D}`;
            }

            // Format date for display
            function formatDate(dateStr) {
                if (!dateStr) return '—';
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }

            // Format date for input fields
            function formatDateForInput(dateStr) {
                if (!dateStr) return '';
                return dateStr.split('T')[0];
            }

            // Capitalize first letter
            function capitalizeFirstLetter(string) {
                if (!string) return '';
                return string.charAt(0).toUpperCase() + string.slice(1);
            }

            // Show message
            function showMessage(message, type = 'info') {
                const alertClass = type === 'success' ? 'alert-success' :
                                  type === 'error' ? 'alert-danger' : 'alert-info';

                const alertDiv = $('<div>', {
                    class: `alert ${alertClass} alert-dismissible fade show`,
                    role: 'alert'
                }).html(`
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `);

                $('#message-container').html(alertDiv);
                setTimeout(() => alertDiv.alert('close'), 5000);
            }

            function showCalendarLoader() {
                $('#calendar-loader').removeClass('d-none').addClass('show');
            }

            function hideCalendarLoader() {
                $('#calendar-loader').addClass('d-none').removeClass('show');
            }

            // ─────────────────────────────────────────────────────────────────────────────
            // 2. ENHANCED MOBILE TOUCH EVENT HANDLERS
            // ─────────────────────────────────────────────────────────────────────────────

            function addMobileTouchEvents(element, clickHandler) {
                if (!element) return;

                let touchStartTime = 0;
                let touchMoved = false;
                let touchStartPos = { x: 0, y: 0 };

                // Add visual feedback class
                element.classList.add('touchable-element');

                // Touch start
                element.addEventListener('touchstart', function(e) {
                    touchStartTime = Date.now();
                    touchMoved = false;
                    touchStartPos = {
                        x: e.touches[0].clientX,
                        y: e.touches[0].clientY
                    };

                    // Add pressed state
                    element.classList.add('touch-pressed');

                    // Haptic feedback
                    if (navigator.vibrate) {
                        navigator.vibrate(10);
                    }

                    e.stopPropagation();
                }, { passive: false });

                // Touch move
                element.addEventListener('touchmove', function(e) {
                    const moveThreshold = 10; // pixels
                    const currentPos = {
                        x: e.touches[0].clientX,
                        y: e.touches[0].clientY
                    };

                    const distance = Math.sqrt(
                        Math.pow(currentPos.x - touchStartPos.x, 2) +
                        Math.pow(currentPos.y - touchStartPos.y, 2)
                    );

                    if (distance > moveThreshold) {
                        touchMoved = true;
                        element.classList.remove('touch-pressed');
                    }
                }, { passive: true });

                // Touch end
                element.addEventListener('touchend', function(e) {
                    const touchDuration = Date.now() - touchStartTime;

                    // Remove pressed state
                    element.classList.remove('touch-pressed');

                    if (!touchMoved && touchDuration < 800) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();

                        // Add clicked animation
                        element.classList.add('touch-clicked');
                        setTimeout(() => {
                            element.classList.remove('touch-clicked');
                        }, 150);

                        // Execute click handler with slight delay for visual feedback
                        setTimeout(() => {
                            clickHandler(e);
                        }, 50);
                    }
                }, { passive: false });

                // Touch cancel
                element.addEventListener('touchcancel', function(e) {
                    element.classList.remove('touch-pressed');
                    touchMoved = true;
                }, { passive: true });

                // Desktop click events with enhanced feedback
                element.addEventListener('click', function(e) {
                    if (!isMobile) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();

                        // Add clicked animation for desktop
                        element.classList.add('click-animation');
                        setTimeout(() => {
                            element.classList.remove('click-animation');
                        }, 150);

                        clickHandler(e);
                    }
                });

                // Enhanced hover effects for desktop
                if (!isMobile) {
                    element.addEventListener('mouseenter', function() {
                        element.classList.add('hover-effect');
                    });

                    element.addEventListener('mouseleave', function() {
                        element.classList.remove('hover-effect');
                    });
                }
            }

            // Enhanced shift selection popup with better UX
            function showShiftSelectionPopup(dateStr) {
                // Prevent multiple modals
                if ($('#shiftSelectionModal').length > 0) {
                    return;
                }

                // Close any existing modals
                $('.modal').modal('hide');

                const shifts = shiftMap[dateStr] || [];
                const bookedShiftTypes = shifts.map(s => s.shift);

                let popupHtml = `
                    <div class="modal fade" id="shiftSelectionModal" tabindex="-1" data-bs-backdrop="static">
                        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="bi bi-calendar-check me-2"></i>Select Action
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="date-info mb-3 p-3 bg-light rounded">
                                        <i class="bi bi-calendar-date me-2 text-primary"></i>
                                        <strong>${formatDate(dateStr)}</strong>
                                    </div>
                                    <div class="d-grid gap-3">
                `;

                // Show available shifts for booking
                const availableShifts = [];
                if (!bookedShiftTypes.includes('morning') && !bookedShiftTypes.includes('full day')) {
                    availableShifts.push('morning');
                }
                if (!bookedShiftTypes.includes('evening') && !bookedShiftTypes.includes('full day')) {
                    availableShifts.push('evening');
                }
                if (!bookedShiftTypes.includes('full day') && bookedShiftTypes.length === 0) {
                    availableShifts.push('full day');
                }

                // Add booking options for available shifts
                availableShifts.forEach(shift => {
                    const shiftIcon = shift === 'morning' ? 'sunrise' : shift === 'evening' ? 'sunset' : 'sun';
                    const shiftColor = shift === 'morning' ? 'warning' : shift === 'evening' ? 'info' : 'success';

                    popupHtml += `
                        <button class="btn btn-outline-${shiftColor} btn-lg shift-action-btn d-flex align-items-center justify-content-center"
                                data-action="book"
                                data-date="${dateStr}"
                                data-shift="${shift}"
                                style="min-height: 60px;">
                            <div class="text-center">
                                <i class="bi bi-${shiftIcon} fs-4 mb-1 d-block"></i>
                                <span class="fw-bold">Book ${capitalizeFirstLetter(shift)}</span>
                            </div>
                        </button>
                    `;
                });

                // Add view options for booked shifts
                const bookedShiftTypesUnique = [...new Set(bookedShiftTypes)];
                bookedShiftTypesUnique.forEach(shift => {
                    const shiftBookings = shifts.filter(s => s.shift === shift);
                    const firstBooking = shiftBookings[0]?.fullBookingData;
                    const shiftIcon = shift === 'morning' ? 'sunrise' : shift === 'evening' ? 'sunset' : 'sun';
                    const shiftColor = shift === 'morning' ? 'warning' : shift === 'evening' ? 'info' : 'success';

                    popupHtml += `
                        <button class="btn btn-${shiftColor} btn-lg shift-action-btn d-flex align-items-center"
                                data-action="view"
                                data-date="${dateStr}"
                                data-shift="${shift}"
                                style="min-height: 60px;">
                            <div class="me-3">
                                <i class="bi bi-${shiftIcon} fs-4"></i>
                            </div>
                            <div class="flex-grow-1 text-start">
                                <div class="fw-bold">${capitalizeFirstLetter(shift)} Booking${shiftBookings.length > 1 ? 's' : ''}</div>
                                <small class="opacity-75">
                                    ${firstBooking?.customerName || 'Customer'}
                                    ${shiftBookings.length > 1 ? `+ ${shiftBookings.length - 1} more` : ''}
                                </small>
                            </div>
                            <div>
                                <i class="bi bi-eye fs-5"></i>
                            </div>
                        </button>
                    `;
                });

                popupHtml += `
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-x-circle me-1"></i>Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Add to body
                $('body').append(popupHtml);

                // Initialize modal with enhanced options
                const modal = new bootstrap.Modal(document.getElementById('shiftSelectionModal'), {
                    backdrop: 'static',
                    keyboard: true,
                    focus: true
                });

                // Enhanced click handlers with loading states
                $(document).on('click', '.shift-action-btn', function() {
                    const $btn = $(this);
                    const action = $btn.data('action');
                    const date = $btn.data('date');
                    const shift = $btn.data('shift');

                    // Add loading state
                    const originalHtml = $btn.html();
                    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Loading...');

                    // Hide modal with callback
                    modal.hide();

                    $('#shiftSelectionModal').on('hidden.bs.modal', function() {
                        setTimeout(() => {
                            if (action === 'book') {
                                openBookingModalWithShift(date, shift);
                            } else if (action === 'view') {
                                viewShiftBookingsForDate(date, shift);
                            }
                        }, 100);
                    });
                });

                // Clean up when modal is hidden
                $('#shiftSelectionModal').on('hidden.bs.modal', function() {
                    $(this).remove();
                    $(document).off('click', '.shift-action-btn');
                });

                // Show modal with animation
                modal.show();

                // Focus first action button for accessibility
                setTimeout(() => {
                    $('.shift-action-btn').first().focus();
                }, 300);
            }

            function viewShiftBookingsForDate(dateStr, shiftType) {
                // Show loading state
                showToast('Loading booking details...', 'info');

                const shifts = shiftMap[dateStr].filter(s => s.shift === shiftType);

                setTimeout(() => {
                    if (shifts.length === 1) {
                        // Single booking - show details directly
                        viewBookingDetails(shifts[0].fullBookingData);
                    } else if (shifts.length > 1) {
                        // Multiple bookings - show selection list
                        showMultipleBookingOptions(shiftType.toUpperCase(), shifts);
                    } else {
                        // No bookings found (shouldn't happen)
                        showMessage('No bookings found for this shift.', 'error');
                    }
                }, 200);
            }

            // ─────────────────────────────────────────────────────────────────────────────
            // 4. MODAL OPENING FUNCTIONS
            // ─────────────────────────────────────────────────────────────────────────────

            function openBookingModalWithShift(dateStr, shiftType) {
                resetBookingForm();
                $('#bookingModalLabel').text('Add New Booking');
                $('#delete-booking').addClass('d-none');

                // Set dates
                $('#fromDate').val(dateStr);
                $('#toDate').val(dateStr);

                // Set shift type
                $('#shiftType').val(shiftType === 'full day' ? 'fullday' : shiftType);

                // Generate date-wise shifts if not full day
                if (shiftType !== 'full day') {
                    generateDateWiseShifts();
                    // Auto-select the specific shift
                    setTimeout(() => {
                        $(`input[name="shifts[${dateStr}]"][value="${shiftType}"]`).prop('checked', true);
                        $(`#time-container-${dateStr}-${shiftType}`).show();
                    }, 100);
                }

                bookingModal.show();
            }

            function openBookingModal(dateStr = '') {
                resetBookingForm();
                $('#bookingModalLabel').text('Add New Booking');
                $('#delete-booking').addClass('d-none');

                const today = new Date().toISOString().split('T')[0];
                $('#fromDate').val(dateStr || today);
                $('#toDate').val(dateStr || today);

                generateDateWiseShifts();
                bookingModal.show();
            }

            function openBookingModalForEdit(bookingData) {
                resetBookingForm();
                $('#bookingModalLabel').text('Edit Booking');
                $('#delete-booking').removeClass('d-none');

                // Populate all fields
                $('#bookingId').val(bookingData.bookingId);
                $('#userId').val(bookingData.userId || 1);
                $('#EventName').val(bookingData.eventName);
                $('#fromDate').val(formatDateForInput(bookingData.fromDate));
                $('#toDate').val(formatDateForInput(bookingData.toDate));
                $('#shiftType').val(bookingData.shiftType);
                $('#bookingStatus').val(bookingData.bookingStatus);
                $('#totalAmount').val(bookingData.totalAmount);
                $('#advancePayment').val(bookingData.advancePayment);
                $('#remainingPayment').val(bookingData.remainingPayment);
                $('#paymentStatus').val(bookingData.paymentStatus);
                $('#customerName').val(bookingData.customerName);
                $('#phoneNumber').val(bookingData.phoneNumber);
                $('#alternativeNumber').val(bookingData.alternativeNumber);
                $('#address').val(bookingData.address);

                if (bookingData.shiftType !== 'fullday') {
                    generateDateWiseShifts();
                    if (bookingData.dateWiseShifts) {
                        setTimeout(() => {
                            try {
                                const dateWiseShifts = JSON.parse(bookingData.dateWiseShifts);
                                Object.entries(dateWiseShifts).forEach(([date, shifts]) => {
                                    shifts.forEach(shiftData => {
                                        if (typeof shiftData === 'string') {
                                            $(`input[name="shifts[${date}]"][value="${shiftData}"]`).prop('checked', true);
                                            $(`#time-container-${date}-${shiftData}`).show();
                                        } else {
                                            const shiftValue = shiftData.shift;
                                            $(`input[name="shifts[${date}]"][value="${shiftValue}"]`).prop('checked', true);
                                            $(`#time-container-${date}-${shiftValue}`).show();
                                            if (shiftData.startTime) {
                                                $(`input[name="shift-start[${date}][${shiftValue}]"]`).val(shiftData.startTime);
                                            }
                                            if (shiftData.endTime) {
                                                $(`input[name="shift-end[${date}][${shiftValue}]"]`).val(shiftData.endTime);
                                            }
                                        }
                                    });
                                });
                            } catch (e) {
                                console.error("Error parsing dateWiseShifts:", e);
                            }
                        }, 100);
                    }
                }

                calculateRemainingPayment();
                bookingModal.show();
            }

            // ─────────────────────────────────────────────────────────────────────────────
            // 5. FULLCALENDAR SETUP WITH FIXED MOBILE TOUCH SUPPORT
            // ─────────────────────────────────────────────────────────────────────────────

            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                selectable: true,
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title'
                },

                // FIXED: Enhanced date click with debouncing and better UX
                dateClick(info) {
                    // Debounce to prevent multiple rapid clicks
                    if (this.dateClickTimeout) {
                        clearTimeout(this.dateClickTimeout);
                    }

                    this.dateClickTimeout = setTimeout(() => {
                        const dateStr = info.dateStr;
                        const shifts = shiftMap[dateStr] || [];

                        // Prevent any other modals from interfering
                        $('.modal').modal('hide');

                        const bookedShiftTypes = shifts.map(s => s.shift);
                        const isCompletelyEmpty = bookedShiftTypes.length === 0;

                        // Add visual feedback to the clicked date cell
                        const dayCell = info.dayEl;
                        dayCell.classList.add('click-animation');
                        setTimeout(() => {
                            dayCell.classList.remove('click-animation');
                        }, 200);

                        // Case 1: Empty date — show shift selection popup
                        if (isCompletelyEmpty) {
                            setTimeout(() => {
                                showShiftSelectionPopup(dateStr);
                            }, 150);
                            return;
                        }

                        // Case 2: Partially or Fully Booked — show "Select Action" popup
                        setTimeout(() => {
                            showShiftSelectionPopup(dateStr);
                        }, 150);
                    }, 100);
                },

                // Enhanced day cell mounting with mobile touch events
                dayCellDidMount(arg) {
                    const dateStr = localYMD(arg.date);
                    const shifts = shiftMap[dateStr] || [];

                    arg.el.style.position = 'relative';
                    arg.el.style.overflow = 'hidden';

                    if (!shifts.length) return;

                    const COLORS = {
                        'full day': 'rgba(34,197,94,0.85)',
                        'morning': 'rgba(255,165,0,0.85)',
                        'evening': 'rgba(0,128,255,0.85)'
                    };
                    const POS = {
                        'full day': { top: '0', bottom: '0', left: '0', right: '0' },
                        'morning': { top: '0', height: '50%', left: '0', right: '0' },
                        'evening': { bottom: '0', height: '50%', left: '0', right: '0' }
                    };

                    const byType = shifts.reduce((acc, s) => {
                        (acc[s.shift] = acc[s.shift] || []).push(s);
                        return acc;
                    }, {});

                    const hasFull = byType['full day'];
                    const hasMorn = byType['morning'];
                    const hasEven = byType['evening'];

                    // Add empty shift areas with mobile touch support
                    if (!hasFull && (hasMorn || hasEven)) {
                        const emptyArea = document.createElement('div');
                        emptyArea.className = 'empty-shift-area';
                        Object.assign(emptyArea.style, {
                            position: 'absolute',
                            backgroundColor: 'rgba(240,240,240,0.4)',
                            cursor: 'pointer',
                            zIndex: '9998',
                            border: '1px dashed rgba(0,0,0,0.15)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            width: '100%'
                        });

                        if (hasMorn && !hasEven) {
                            Object.assign(emptyArea.style, { bottom: '0', height: '50%' });
                            const t = document.createElement('span');
                            t.className = 'empty-shift-text';
                            t.innerText = 'Book Evening';
                            emptyArea.appendChild(t);
                            addMobileTouchEvents(emptyArea, (e) => {
                                openBookingModalWithShift(dateStr, 'evening');
                            });
                        }
                        else if (!hasMorn && hasEven) {
                            Object.assign(emptyArea.style, { top: '0', height: '50%' });
                            const t = document.createElement('span');
                            t.className = 'empty-shift-text';
                            t.innerText = 'Book Morning';
                            emptyArea.appendChild(t);
                            addMobileTouchEvents(emptyArea, (e) => {
                                openBookingModalWithShift(dateStr, 'morning');
                            });
                        }

                        arg.el.appendChild(emptyArea);
                    }

                    // Render booked shifts with mobile touch support
                    Object.entries(byType).forEach(([type, list]) => {
                        const firstBooking = list[0];

                        const block = createShiftBlockWithTouch(
                            type.toUpperCase(),
                            COLORS[type],
                            () => showShiftSelectionPopup(dateStr), // ✅ Fixed: now date is derived safely
                            firstBooking
                        );

                        Object.assign(block.style, POS[type]);

                        const frame = arg.el.querySelector('.fc-daygrid-day-frame');
                        if (frame) {
                            frame.appendChild(block);
                        } else {
                            arg.el.appendChild(block);
                        }
                    });

                },

                datesSet() {
                    refreshCalendar();
                },

                windowResize(view) {
                    calendar.changeView('dayGridMonth');
                }
            });

            // ─────────────────────────────────────────────────────────────────────────────
            // 6. SHIFT BLOCK CREATION WITH FIXED MOBILE TOUCH SUPPORT
            // ─────────────────────────────────────────────────────────────────────────────

            function createShiftBlockWithTouch(labelText, bgColor, onClick, bookingData) {
                const div = document.createElement('div');
                div.className = 'shift-block';
                Object.assign(div.style, {
                    position: 'absolute',
                    backgroundColor: bgColor,
                    cursor: 'pointer',
                    zIndex: '9999',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    width: '100%',
                    padding: '4px 6px',
                    borderRadius: '6px',
                    minHeight: '35px'
                });

                // Customer name (instead of shift type)
                const customerText = bookingData && bookingData.fullBookingData && bookingData.fullBookingData.customerName;
                if (customerText) {
                    const customer = document.createElement('div');
                    customer.className = 'shift-customer';
                    customer.innerText = customerText.length > 12 ? customerText.substring(0, 12) + '...' : customerText;
                    div.appendChild(customer);
                }

                // Address line
                const addrText = bookingData && bookingData.fullBookingData && bookingData.fullBookingData.address;
                if (addrText) {
                    const addr = document.createElement('div');
                    addr.className = 'shift-address';
                    addr.innerText = addrText.length > 15 ? addrText.substring(0, 15) + '...' : addrText;
                    div.appendChild(addr);
                }

                // Event name if no customer or address
                if (!customerText && !addrText) {
                    const eventText = bookingData && bookingData.fullBookingData && bookingData.fullBookingData.eventName;
                    if (eventText) {
                        const event = document.createElement('div');
                        event.className = 'shift-customer';
                        event.innerText = eventText.length > 12 ? eventText.substring(0, 12) + '...' : eventText;
                        div.appendChild(event);
                    }
                }

                // FIXED: Add mobile touch events that prevent calendar date click
                addMobileTouchEvents(div, (e) => {
                    onClick();
                });

                return div;
            }

            // ─────────────────────────────────────────────────────────────────────────────
            // 7. BOOKING DETAILS AND MULTIPLE BOOKING HANDLING
            // ─────────────────────────────────────────────────────────────────────────────

            function showMultipleBookingOptions(shiftLabel, bookings) {
                let modalHtml = `
                    <h5 class="mb-3">${shiftLabel} Bookings</h5>
                    <div class="list-group">`;

                bookings.forEach((b, idx) => {
                    const booking = b.fullBookingData;
                    modalHtml += `
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                            onclick="window.selectBookingFromList(${idx})">
                            <div>
                                <strong>${booking.customerName || 'Unnamed'}</strong>
                                <br><small class="text-muted">${booking.phoneNumber || 'No phone'}</small>
                            </div>
                            <span class="badge bg-secondary rounded-pill">View Details</span>
                        </button>`;
                });
                modalHtml += `</div>`;

                $('#multiBookingBody').html(modalHtml);
                window._bookingListBuffer = bookings;
                multiBookingModal.show();
            }

            window.selectBookingFromList = function(index) {
                multiBookingModal.hide();
                const booking = window._bookingListBuffer[index];
                setTimeout(() => {
                    viewBookingDetails(booking.fullBookingData);
                }, 300);
            };

            function viewBookingDetails(booking) {
                const fromDate = formatDate(booking.fromDate);
                const toDate = formatDate(booking.toDate);

                let detailsHtml = `
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Event Details</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-4 fw-bold">Event Name:</div>
                                <div class="col-8">${booking.eventName || '—'}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4 fw-bold">Date Range:</div>
                                <div class="col-8">${fromDate} to ${toDate}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4 fw-bold">Shift Type:</div>
                                <div class="col-8">${capitalizeFirstLetter(booking.shiftType) || 'Full Day'}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4 fw-bold">Status:</div>
                                <div class="col-8">
                                    <span class="badge ${booking.bookingStatus === 'Confirmed' ? 'bg-success' :
                                                      booking.bookingStatus === 'Tentative' ? 'bg-warning' :
                                                      'bg-secondary'}">
                                        ${booking.bookingStatus || 'Unknown'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-person me-2"></i>Customer Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-4 fw-bold">Name:</div>
                                <div class="col-8">${booking.customerName || '—'}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4 fw-bold">Phone:</div>
                                <div class="col-8">
                                    ${booking.phoneNumber ? `<a href="tel:${booking.phoneNumber}" class="text-decoration-none">${booking.phoneNumber}</a>` : '—'}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4 fw-bold">Alt. Phone:</div>
                                <div class="col-8">
                                    ${booking.alternativeNumber ? `<a href="tel:${booking.alternativeNumber}" class="text-decoration-none">${booking.alternativeNumber}</a>` : '—'}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4 fw-bold">Address:</div>
                                <div class="col-8">${booking.address || '—'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-credit-card me-2"></i>Payment Details</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-4 fw-bold">Total Amount:</div>
                                <div class="col-8">₹${(booking.totalAmount || 0).toLocaleString('en-IN')}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4 fw-bold">Advance Paid:</div>
                                <div class="col-8">₹${(booking.advancePayment || 0).toLocaleString('en-IN')}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4 fw-bold">Balance Due:</div>
                                <div class="col-8">₹${(booking.remainingPayment || 0).toLocaleString('en-IN')}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4 fw-bold">Payment Status:</div>
                                <div class="col-8">
                                    <span class="badge ${booking.paymentStatus === 'Paid' ? 'bg-success' :
                                                      booking.paymentStatus === 'Partially Paid' ? 'bg-warning' :
                                                      'bg-danger'}">
                                        ${booking.paymentStatus || 'Unknown'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 d-flex flex-wrap gap-2 justify-content-between">
                        <button id="edit-from-details" class="btn btn-primary flex-fill">
                            <i class="bi bi-pencil-fill me-1"></i> Edit Booking
                        </button>
                        <button id="send-whatsapp-confirm" class="btn btn-success flex-fill">
                            <i class="bi bi-whatsapp me-1"></i> Send Confirmation
                        </button>
                    </div>
                `;

                $('#detailsModalLabel').text(booking.eventName || 'Booking Details');
                $('.booking-details').html(detailsHtml);

                $('.modal').modal('hide');

                setTimeout(() => {
                    $('#edit-from-details').off('click').on('click', function() {
                        detailsModal.hide();
                        setTimeout(() => {
                            openBookingModalForEdit(booking);
                        }, 300);
                    });

                    $('#send-whatsapp-confirm').off('click').on('click', function() {
                        sendWhatsAppConfirmation(booking);
                    });

                    detailsModal.show();
                }, 300);
            }

            function sendWhatsAppConfirmation(booking) {
                const fromDate = formatDate(booking.fromDate);
                const phoneNumber = (booking.phoneNumber || '').replace(/\D/g, '');

                if (!phoneNumber) {
                    showToast("No phone number available for this booking.", 'warning');
                    return;
                }

                const message = `Thank you ${booking.customerName || 'Customer'} for booking with us. Your booking for "${booking.eventName || 'Event'}" has been confirmed for ${fromDate}.`;
                const encodedMessage = encodeURIComponent(message);
                window.open(`https://wa.me/${phoneNumber}?text=${encodedMessage}`, '_blank');
                showToast('Confirmation message prepared for WhatsApp', 'success');
            }

            function showToast(message, type = 'info') {
                let toastContainer = document.getElementById('toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.id = 'toast-container';
                    toastContainer.className = 'toast-container';
                    document.body.appendChild(toastContainer);
                }

                const toastId = 'toast-' + Date.now();
                const toast = document.createElement('div');
                toast.className = `toast align-items-center text-white bg-${type} border-0`;
                toast.id = toastId;
                toast.setAttribute('role', 'alert');

                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                `;

                toastContainer.appendChild(toast);
                const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: 3000 });
                bsToast.show();

                toast.addEventListener('hidden.bs.toast', function() {
                    toast.remove();
                });
            }

            // ─────────────────────────────────────────────────────────────────────────────
            // 8. FORM HANDLING AND VALIDATION
            // ─────────────────────────────────────────────────────────────────────────────

            function resetBookingForm() {
                $('#bookingFormFields')[0].reset();
                $('#bookingId').val('');
                $('#userId').val('1');
                $('#bookingStatus').val('Confirmed');
                $('#shiftType').val('morning');
                $('#dateWiseShiftContainer').empty();
                $('#modal-message').removeClass('alert-success alert-danger').addClass('d-none').text('');
                $('.error-message').remove();
                $('.was-validated').removeClass('was-validated');
            }

            function validateBookingForm() {
                $('.error-message').remove();
                let isValid = true;

                const requiredFields = [
                    { id: 'EventName', name: 'Event' },
                    { id: 'fromDate', name: 'From Date' },
                    { id: 'toDate', name: 'To Date' },
                    { id: 'bookingStatus', name: 'Booking Status' },
                    { id: 'totalAmount', name: 'Total Amount' },
                    { id: 'customerName', name: 'Customer Name' },
                    { id: 'phoneNumber', name: 'Phone Number' }
                ];

                requiredFields.forEach(field => {
                    const $f = $(`#${field.id}`);
                    const $parent = $f.parent();
                    if (!$f.val().trim()) {
                        $parent.append(`<div class="error-message text-danger small mt-1"><i class="bi bi-exclamation-triangle me-1"></i>${field.name} is required</div>`);
                        $f.addClass('is-invalid');
                        isValid = false;
                    } else {
                        $f.removeClass('is-invalid').addClass('is-valid');
                    }
                });

                const fromDateStr = $('#fromDate').val();
                const toDateStr = $('#toDate').val();
                if (fromDateStr && toDateStr) {
                    const fromD = new Date(fromDateStr);
                    const toD = new Date(toDateStr);
                    if (fromD > toD) {
                        $('#fromDate').parent().append('<div class="error-message text-danger small mt-1"><i class="bi bi-exclamation-triangle me-1"></i>From Date must be before or equal to To Date</div>');
                        $('#fromDate, #toDate').addClass('is-invalid');
                        isValid = false;
                    }
                }

                const phone = $('#phoneNumber').val().trim();
                if (phone && !/^[0-9]{10}$/.test(phone)) {
                    $('#phoneNumber').parent().append('<div class="error-message text-danger small mt-1"><i class="bi bi-exclamation-triangle me-1"></i>Please enter a valid 10-digit phone number</div>');
                    $('#phoneNumber').addClass('is-invalid');
                    isValid = false;
                }

                const totalAmount = parseFloat($('#totalAmount').val());
                if (totalAmount && totalAmount < 0) {
                    $('#totalAmount').parent().append('<div class="error-message text-danger small mt-1"><i class="bi bi-exclamation-triangle me-1"></i>Total amount cannot be negative</div>');
                    $('#totalAmount').addClass('is-invalid');
                    isValid = false;
                }

                const shiftType = $('#shiftType').val();
                if (shiftType !== 'fullday') {
                    const missingDates = [];
                    let d = new Date(fromDateStr);
                    while (d <= new Date(toDateStr)) {
                        const key = d.toISOString().split('T')[0];
                        if ($(`input[name="shifts[${key}]"]:checked`).length === 0) {
                            missingDates.push(key);
                        }
                        d.setDate(d.getDate() + 1);
                    }
                    if (missingDates.length) {
                        $('#dateWiseShiftContainer').prepend(
                            `<div class="error-message alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Please select at least one shift for: ${missingDates.join(', ')}
                            </div>`
                        );
                        isValid = false;
                    }
                }

                if (!isValid) {
                    // Focus first invalid field and scroll to it
                    const firstInvalid = $('.is-invalid').first();
                    if (firstInvalid.length) {
                        firstInvalid.focus();
                        firstInvalid[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return false;
                }

                // Conflict detection
                const bookingId = parseInt($('#bookingId').val()) || 0;
                const fromD = new Date(fromDateStr);
                const toD = new Date(toDateStr);

                function forEachDate(fn) {
                    const cur = new Date(fromD);
                    while (cur <= toD) {
                        fn(cur.toISOString().split('T')[0]);
                        cur.setDate(cur.getDate() + 1);
                    }
                }

                if (shiftType === 'fullday') {
                    forEachDate(dateKey => {
                        const existing = (shiftMap[dateKey] || [])
                            .filter(s => s.fullBookingData.bookingId !== bookingId);
                        if (existing.length) {
                            $('#fromDate').parent().append(
                                `<div class="error-message text-danger small mt-1">
                                   <i class="bi bi-exclamation-triangle me-1"></i>Cannot book full day on ${dateKey}: existing booking(s) present
                                 </div>`
                            );
                            isValid = false;
                        }
                    });
                } else {
                    const newShifts = {};
                    $(`input[name^="shifts["]:checked`).each(function() {
                        const dateKey = $(this).attr('name').match(/\[(.*?)\]/)[1];
                        const shiftVal = $(this).val();
                        const startT = $(`input[name="shift-start[${dateKey}][${shiftVal}]"]`).val();
                        const endT = $(`input[name="shift-end[${dateKey}][${shiftVal}]"]`).val();
                        newShifts[dateKey] = newShifts[dateKey] || [];
                        newShifts[dateKey].push({ shift: shiftVal, startTime: startT, endTime: endT });
                    });

                    Object.entries(newShifts).forEach(([dateKey, shiftsArr]) => {
                        const existing = (shiftMap[dateKey] || [])
                            .filter(s => s.fullBookingData.bookingId !== bookingId);

                        if (existing.some(s => s.shift === 'full day')) {
                            $('#dateWiseShiftContainer').prepend(
                                `<div class="error-message alert alert-danger mb-3">
                                   <i class="bi bi-exclamation-triangle me-2"></i>
                                   Cannot book any shift on ${dateKey}: full day already booked
                                 </div>`
                            );
                            isValid = false;
                        }

                        shiftsArr.forEach(ns => {
                            if (existing.some(s => s.shift === ns.shift)) {
                                $('#dateWiseShiftContainer').prepend(
                                    `<div class="error-message alert alert-danger mb-3">
                                       <i class="bi bi-exclamation-triangle me-2"></i>
                                       Shift conflict: ${capitalizeFirstLetter(ns.shift)} on ${dateKey}
                                     </div>`
                                );
                                isValid = false;
                            }

                            existing.forEach(es => {
                                const raw = es.fullBookingData.dateWiseShifts;
                                if (!raw) return;
                                let parsed;
                                try { parsed = JSON.parse(raw); }
                                catch { return; }
                                const existList = parsed[dateKey] || [];
                                existList.forEach(eitem => {
                                    if (typeof eitem !== 'object' || eitem.shift !== ns.shift) return;
                                    const eStart = eitem.startTime || (ns.shift==='morning' ? '08:00' : '16:00');
                                    const eEnd = eitem.endTime || (ns.shift==='morning' ? '12:00' : '20:00');
                                    if (ns.startTime && ns.endTime) {
                                        if (!(ns.endTime <= eStart || ns.startTime >= eEnd)) {
                                            $('#dateWiseShiftContainer').prepend(
                                                `<div class="error-message alert alert-danger mb-3">
                                                   <i class="bi bi-exclamation-triangle me-2"></i>
                                                   Time overlap on ${dateKey} (${ns.startTime}-${ns.endTime})
                                                     conflicts with existing (${eStart}-${eEnd})
                                                 </div>`
                                            );
                                            isValid = false;
                                        }
                                    }
                                });
                            });
                        });
                    });
                }

                return isValid;
            }

            function saveBooking() {
                const formData = {
                    bookingId: $('#bookingId').val() || 0,
                    userId: $('#userId').val() || 1,
                    EventName: $('#EventName').val(),
                    fromDate: $('#fromDate').val(),
                    toDate: $('#toDate').val(),
                    shiftType: $('#shiftType').val(),
                    bookingStatus: $('#bookingStatus').val(),
                    totalAmount: parseFloat($('#totalAmount').val()),
                    advancePayment: parseFloat($('#advancePayment').val()) || 0,
                    remainingPayment: parseFloat($('#remainingPayment').val()),
                    paymentStatus: $('#paymentStatus').val(),
                    customerName: $('#customerName').val(),
                    phoneNumber: $('#phoneNumber').val(),
                    alternativeNumber: $('#alternativeNumber').val(),
                    address: $('#address').val()
                };

                if (formData.shiftType !== 'fullday') {
                    const dateWiseShifts = {};
                    $(`input[name^="shifts["]:checked`).each(function() {
                        const nameAttr = $(this).attr('name');
                        const dateStr = nameAttr.match(/shifts\[(.*?)\]/)[1];
                        const shiftValue = $(this).val();

                        if (!dateWiseShifts[dateStr]) {
                            dateWiseShifts[dateStr] = [];
                        }

                        const startTime = $(`input[name="shift-start[${dateStr}][${shiftValue}]"]`).val();
                        const endTime = $(`input[name="shift-end[${dateStr}][${shiftValue}]"]`).val();

                        dateWiseShifts[dateStr].push({
                            shift: shiftValue,
                            startTime: startTime,
                            endTime: endTime
                        });
                    });
                    formData.dateWiseShifts = JSON.stringify(dateWiseShifts);
                }

                $('#modal-message')
                    .removeClass('d-none alert-danger')
                    .addClass('alert-info')
                    .html('<i class="bi bi-hourglass-split me-2"></i>Processing your request...');

                $('#save-booking').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Saving...');

                $.ajax({
                    url: '/EventBooking/AddOrUpdateEventBooking',
                    type: 'POST',
                    data: {eventBooking: formData},
                    success: function(response) {
                        if (response.success) {
                            $('#modal-message')
                                .removeClass('alert-info alert-danger')
                                .addClass('alert-success')
                                .html('<i class="bi bi-check-circle me-2"></i>' + response.message);

                            setTimeout(() => {
                                bookingModal.hide();
                                loadEvents();
                                showToast('Booking saved successfully!', 'success');
                            }, 1500);
                        } else {
                            $('#modal-message')
                                .removeClass('alert-info alert-success')
                                .addClass('alert-danger')
                                .html('<i class="bi bi-exclamation-triangle me-2"></i>' + (response.message || 'Error saving booking.'));
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON && xhr.responseJSON.message
                            ? xhr.responseJSON.message
                            : 'Failed to save booking. Please try again.';

                        $('#modal-message')
                            .removeClass('alert-info alert-success')
                            .addClass('alert-danger')
                            .html('<i class="bi bi-exclamation-triangle me-2"></i>' + errorMsg);
                    },
                    complete: function() {
                        $('#save-booking').prop('disabled', false).html('<i class="bi bi-save me-1"></i>Save Booking');
                    }
                });
            }

            function deleteBooking(bookingId) {
                if (!confirm('Are you sure you want to delete this booking? This action cannot be undone.')) {
                    return;
                }

                $('#modal-message')
                    .removeClass('d-none alert-success alert-danger')
                    .addClass('alert-info')
                    .html('<i class="bi bi-hourglass-split me-2"></i>Deleting booking...');

                $('#delete-booking').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Deleting...');

                $.ajax({
                    url: `/EventBooking/Delete/${bookingId}`,
                    type: 'POST',
                    success: function(response) {
                        if (response.success) {
                            $('#modal-message')
                                .removeClass('alert-info alert-danger')
                                .addClass('alert-success')
                                .html('<i class="bi bi-check-circle me-2"></i>' + response.message);

                            setTimeout(() => {
                                bookingModal.hide();
                                loadEvents();
                                showToast('Booking deleted successfully!', 'success');
                            }, 1500);
                        } else {
                            $('#modal-message')
                                .removeClass('alert-info alert-success')
                                .addClass('alert-danger')
                                .html('<i class="bi bi-exclamation-triangle me-2"></i>' + (response.message || 'Error deleting booking.'));
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON && xhr.responseJSON.message
                            ? xhr.responseJSON.message
                            : 'Failed to delete booking. Please try again.';

                        $('#modal-message')
                            .removeClass('alert-info alert-success')
                            .addClass('alert-danger')
                            .html('<i class="bi bi-exclamation-triangle me-2"></i>' + errorMsg);
                    },
                    complete: function() {
                        $('#delete-booking').prop('disabled', false).html('<i class="bi bi-trash me-1"></i>Delete');
                    }
                });
            }

            function generateDateWiseShifts() {
                const fromDateStr = $('#fromDate').val();
                const toDateStr = $('#toDate').val();
                const container = $('#dateWiseShiftContainer');

                if (!fromDateStr || !toDateStr) return;

                const fromDate = new Date(fromDateStr);
                const toDate = new Date(toDateStr);

                if (fromDate > toDate) {
                    showMessage('From Date must be before or equal to To Date.', 'error');
                    return;
                }

                container.empty().append(`
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-clock me-2"></i>Select Shifts and Times for Each Date</h5>
                        </div>
                        <div class="card-body shifts-container"></div>
                    </div>
                `);

                const shiftsContainer = container.find('.shifts-container');
                const shiftTypes = ['Morning', 'Evening'];
                const currentDate = new Date(fromDate);

                while (currentDate <= toDate) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const formattedDate = currentDate.toLocaleDateString('en-US', {
                        weekday: 'short',
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });

                    const dateRow = $(`
                        <div class="row border-bottom py-3 mb-3">
                            <div class="col-12 col-md-3 mb-2">
                                <strong class="text-primary">${formattedDate}</strong>
                            </div>
                            <div class="col-12 col-md-9 shift-options-${dateStr}"></div>
                        </div>
                    `);

                    const shiftOptionsContainer = dateRow.find(`.shift-options-${dateStr}`);

                    shiftTypes.forEach(shift => {
                        const shiftId = `shift-${dateStr}-${shift.toLowerCase()}`;
                        const timeContainerId = `time-container-${dateStr}-${shift.toLowerCase()}`;

                        const shiftOption = $(`
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           id="${shiftId}"
                                           name="shifts[${dateStr}]"
                                           value="${shift.toLowerCase()}"
                                           onchange="toggleTimeSelection('${timeContainerId}', this.checked)">
                                    <label class="form-check-label fw-bold" for="${shiftId}">
                                        <i class="bi bi-${shift === 'Morning' ? 'sunrise' : 'sunset'} me-1"></i>
                                        ${shift}
                                    </label>
                                </div>
                                <div id="${timeContainerId}" class="time-selection mt-2" style="display:none;">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text"><i class="bi bi-clock"></i></span>
                                                <span class="input-group-text">Start</span>
                                                <input type="time" class="form-control"
                                                       name="shift-start[${dateStr}][${shift.toLowerCase()}]"
                                                       value="${shift === 'Morning' ? '08:00' : '16:00'}">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text"><i class="bi bi-clock"></i></span>
                                                <span class="input-group-text">End</span>
                                                <input type="time" class="form-control"
                                                       name="shift-end[${dateStr}][${shift.toLowerCase()}]"
                                                       value="${shift === 'Morning' ? '12:00' : '20:00'}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);

                        shiftOptionsContainer.append(shiftOption);
                    });

                    shiftsContainer.append(dateRow);
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                if (!window.toggleTimeSelection) {
                    window.toggleTimeSelection = function(containerId, isChecked) {
                        $(`#${containerId}`).toggle(isChecked);
                    };
                }
            }

            function calculateRemainingPayment() {
                const total = parseFloat($('#totalAmount').val()) || 0;
                const advance = parseFloat($('#advancePayment').val()) || 0;
                const remaining = Math.max(0, total - advance);

                $('#remainingPayment').val(remaining.toFixed(2));

                if (total === 0) {
                    $('#paymentStatus').val('Pending');
                } else if (remaining <= 0) {
                    $('#paymentStatus').val('Paid');
                } else if (advance > 0) {
                    $('#paymentStatus').val('Partially Paid');
                } else {
                    $('#paymentStatus').val('Pending');
                }
            }

            // ─────────────────────────────────────────────────────────────────────────────
            // 9. DATA LOADING AND CALENDAR REFRESH
            // ─────────────────────────────────────────────────────────────────────────────

            function refreshCalendar() {
                calendar.removeAllEvents();
                $('.shift-block, .empty-shift-area').remove();
                loadEvents();
            }

            function loadEvents() {
                showCalendarLoader();

                $.ajax({
                    url: '/EventBooking/GetAllEventBookings',
                    type: 'GET'
                }).done(function (bookings) {
                    shiftMap = {};
                    const bgEvents = [];

                    bookings.forEach(function (booking) {
                        const from = booking.fromDate ? new Date(booking.fromDate) : new Date(booking.createdDate);
                        const to = booking.toDate ? new Date(booking.toDate) :
                            booking.fromDate ? new Date(booking.fromDate) :
                                new Date(booking.createdDate);

                        from.setHours(0, 0, 0, 0);
                        to.setHours(0, 0, 0, 0);

                        const parsedShifts = booking.dateWiseShifts
                            ? JSON.parse(booking.dateWiseShifts)
                            : {};

                        let defaultShift = [];
                        if (booking.shiftType) {
                            const s = booking.shiftType.toLowerCase();
                            if (['morning', 'evening', 'full day'].includes(s)) {
                                defaultShift = [s];
                            }
                        } else {
                            defaultShift = ['full day'];
                        }

                        for (let d = new Date(from); d <= to; d.setDate(d.getDate() + 1)) {
                            const key = localYMD(d);

                            let dayArray;
                            if (parsedShifts.hasOwnProperty(key)) {
                                dayArray = parsedShifts[key].length ? parsedShifts[key] : ['full day'];
                            } else {
                                dayArray = defaultShift;
                            }

                            dayArray.forEach(function (item) {
                                const shiftName = (typeof item === 'string' ? item : item.shift).toLowerCase();
                                if (['morning', 'evening', 'full day'].includes(shiftName)) {
                                    shiftMap[key] = shiftMap[key] || [];
                                    shiftMap[key].push({
                                        shift: shiftName,
                                        fullBookingData: booking
                                    });
                                }
                            });
                        }

                        const bgStart = new Date(from);
                        const bgEnd = new Date(to);
                        bgEnd.setDate(bgEnd.getDate() + 1);

                        bgEvents.push({
                            id: booking.bookingId,
                            title: booking.customerName || '',
                            start: localYMD(bgStart),
                            end: localYMD(bgEnd),
                            display: 'background',
                            backgroundColor: 'rgba(0,0,0,0)',
                            borderColor: 'transparent',
                            extendedProps: booking
                        });
                    });

                    // Load festivals
                    $.getJSON('/hindu_festivals_2025_2034.json', function (festivals) {
                        const currentYear = calendar.view.currentStart.getFullYear();
                        const nextYear = currentYear + 1;

                        const filteredFestivals = festivals.filter(fest => {
                            const year = new Date(fest.date).getFullYear();
                            return year === currentYear || year === nextYear;
                        });

                        const festEvents = filteredFestivals.map(fest => ({
                            title: fest.name,
                            start: fest.date,
                            allDay: true,
                            display: 'auto',
                            backgroundColor: '#FFD700',
                            textColor: '#000',
                            borderColor: '#FFA500',
                            extendedProps: {
                                type: fest.type,
                                region: fest.region
                            }
                        }));

                        calendar.removeAllEvents();
                        [...bgEvents, ...festEvents].forEach(e => calendar.addEvent(e));

                        $('.shift-block, .empty-shift-area').remove();
                        calendar.render();
                        applyShiftBlocksToVisibleDates();
                        hideCalendarLoader();
                    }).fail(function () {
                        calendar.removeAllEvents();
                        bgEvents.forEach(e => calendar.addEvent(e));
                        $('.shift-block, .empty-shift-area').remove();
                        calendar.render();
                        applyShiftBlocksToVisibleDates();
                        hideCalendarLoader();
                    });

                }).fail(function () {
                    showMessage('Failed to load bookings.', 'error');
                    hideCalendarLoader();
                });
            }

            function applyShiftBlocksToVisibleDates() {
                const dateCells = document.querySelectorAll('.fc-daygrid-day');

                dateCells.forEach(cell => {
                    const dateAttr = cell.getAttribute('data-date');
                    if (!dateAttr) return;

                    const shifts = shiftMap[dateAttr] || [];
                    if (!shifts.length) return;

                    cell.style.position = 'relative';
                    cell.style.overflow = 'hidden';

                    const COLORS = {
                        'full day': 'rgba(34,197,94,0.85)',
                        'morning': 'rgba(255,165,0,0.85)',
                        'evening': 'rgba(0,128,255,0.85)'
                    };
                    const POS = {
                        'full day': { top: '0', bottom: '0', left: '0', right: '0' },
                        'morning': { top: '0', height: '50%', left: '0', right: '0' },
                        'evening': { bottom: '0', height: '50%', left: '0', right: '0' }
                    };

                    const byType = shifts.reduce((acc, s) => {
                        (acc[s.shift] = acc[s.shift] || []).push(s);
                        return acc;
                    }, {});

                    const hasFull = byType['full day'];
                    const hasMorn = byType['morning'];
                    const hasEven = byType['evening'];

                    if (!hasFull && (hasMorn || hasEven)) {
                        const emptyArea = document.createElement('div');
                        emptyArea.className = 'empty-shift-area';
                        Object.assign(emptyArea.style, {
                            position: 'absolute',
                            backgroundColor: 'rgba(240,240,240,0.4)',
                            cursor: 'pointer',
                            zIndex: '9998',
                            border: '1px dashed rgba(0,0,0,0.15)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            width: '100%'
                        });

                        if (hasMorn && !hasEven) {
                            Object.assign(emptyArea.style, { bottom: '0', height: '50%' });
                            const t = document.createElement('span');
                            t.className = 'empty-shift-text';
                            t.innerText = 'Book Evening';
                            emptyArea.appendChild(t);
                            addMobileTouchEvents(emptyArea, (e) => {
                                openBookingModalWithShift(dateAttr, 'evening');
                            });
                        }
                        else if (!hasMorn && hasEven) {
                            Object.assign(emptyArea.style, { top: '0', height: '50%' });
                            const t = document.createElement('span');
                            t.className = 'empty-shift-text';
                            t.innerText = 'Book Morning';
                            emptyArea.appendChild(t);
                            addMobileTouchEvents(emptyArea, (e) => {
                                openBookingModalWithShift(dateAttr, 'morning');
                            });
                        }

                        const frame = cell.querySelector('.fc-daygrid-day-frame');
                        if (frame) {
                            frame.appendChild(emptyArea);
                        } else {
                            cell.appendChild(emptyArea);
                        }
                    }

                    Object.entries(byType).forEach(([type, list]) => {
                        const firstBooking = list[0];

                        const block = createShiftBlockWithTouch(
                            type.toUpperCase(),
                            COLORS[type],
                            () => showShiftSelectionPopup(dateAttr), // ✅ Always opens the modal
                            firstBooking
                        );

                        Object.assign(block.style, POS[type]);

                        const frame = cell.querySelector('.fc-daygrid-day-frame');
                        if (frame) {
                            frame.appendChild(block);
                        } else {
                            cell.appendChild(block);
                        }
                    });

                });
            }

            // ─────────────────────────────────────────────────────────────────────────────
            // 10. EVENT HANDLERS AND INITIALIZATION
            // ─────────────────────────────────────────────────────────────────────────────

            $('#save-booking').on('click', function() {
                if (validateBookingForm()) {
                    saveBooking();
                }
            });

            $('#advancePayment, #totalAmount').on('input', function() {
                calculateRemainingPayment();
            });

            $('#shiftType').on('change', function() {
                const selectedValue = $(this).val();
                if (selectedValue === 'fullday') {
                    $('#dateWiseShiftContainer').empty();
                } else {
                    generateDateWiseShifts();
                }
            });

            $('#fromDate, #toDate').on('change', function() {
                const shiftType = $('#shiftType').val();
                if (shiftType !== 'fullday') {
                    generateDateWiseShifts();
                }
            });

            $('#delete-booking').on('click', function() {
                const bookingId = $('#bookingId').val();
                if (bookingId) {
                    deleteBooking(bookingId);
                }
            });

            $('#fetch-bookings').on('click', function() {
                loadEvents();
                showToast('Calendar refreshed!', 'info');
            });

            $('#open-booking-modal').on('click', function() {
                openBookingModal();
            });

            // Enhanced form validation on input
            $('#bookingFormFields input, #bookingFormFields select, #bookingFormFields textarea').on('blur', function() {
                const $this = $(this);
                const $parent = $this.parent();
                $parent.find('.error-message').remove();

                if ($this.prop('required') && !$this.val().trim()) {
                    $this.removeClass('is-valid').addClass('is-invalid');
                } else if ($this.attr('type') === 'tel' && $this.val() && !/^[0-9]{10}$/.test($this.val())) {
                    $this.removeClass('is-valid').addClass('is-invalid');
                } else if ($this.attr('type') === 'number' && $this.val() && parseFloat($this.val()) < 0) {
                    $this.removeClass('is-valid').addClass('is-invalid');
                } else {
                    $this.removeClass('is-invalid').addClass('is-valid');
                }
            });

            // Prevent form submission on Enter key (mobile keyboards)
            $('#bookingFormFields').on('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const inputs = $(this).find('input, select, textarea').not(':hidden');
                    const currentIndex = inputs.index(document.activeElement);
                    if (currentIndex < inputs.length - 1) {
                        inputs.eq(currentIndex + 1).focus();
                    } else {
                        document.activeElement.blur();
                    }
                }
            });

            // Mobile-specific enhancements
            if (isMobile) {
                // Prevent zoom on input focus for iOS
                $('input[type="text"], input[type="tel"], input[type="number"], input[type="date"], input[type="time"], select, textarea').attr('readonly', true);

                setTimeout(() => {
                    $('input[type="text"], input[type="tel"], input[type="number"], input[type="date"], input[type="time"], select, textarea').removeAttr('readonly');
                }, 100);

                // Enhanced touch interactions for calendar
                calendar.setOption('eventClick', function(info) {
                    info.jsEvent.preventDefault();
                    const booking = info.event.extendedProps;
                    if (booking.bookingId) {
                        viewBookingDetails(booking);
                    }
                });

                // Add haptic feedback for touch interactions (iOS)
                if (navigator.vibrate) {
                    $(document).on('touchstart', '.shift-block, .empty-shift-area, .btn', function() {
                        navigator.vibrate(10);
                    });
                }
            }

            // Handle orientation change
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    calendar.updateSize();
                    // Adjust modal heights
                    $('.modal-body').css('max-height', window.innerHeight - 200);
                }, 500);
            });

            // Auto-save form data to prevent loss (sessionStorage fallback)
            let formAutoSaveInterval;
            $('#bookingModal').on('shown.bs.modal', function() {
                formAutoSaveInterval = setInterval(function() {
                    const formData = {};
                    $('#bookingFormFields').find('input, select, textarea').each(function() {
                        if ($(this).attr('type') !== 'hidden') {
                            formData[$(this).attr('id')] = $(this).val();
                        }
                    });
                    try {
                        sessionStorage.setItem('bookingFormDraft', JSON.stringify(formData));
                    } catch (e) {
                        // Silent fail if sessionStorage is not available
                    }
                }, 5000);
            });

            $('#bookingModal').on('hidden.bs.modal', function() {
                if (formAutoSaveInterval) {
                    clearInterval(formAutoSaveInterval);
                }
                try {
                    sessionStorage.removeItem('bookingFormDraft');
                } catch (e) {
                    // Silent fail
                }
            });

            // Restore form data if available
            function restoreFormDraft() {
                try {
                    const draft = sessionStorage.getItem('bookingFormDraft');
                    if (draft) {
                        const formData = JSON.parse(draft);
                        Object.entries(formData).forEach(([key, value]) => {
                            const $field = $(`#${key}`);
                            if ($field.length && value) {
                                $field.val(value);
                            }
                        });
                        calculateRemainingPayment();
                        showToast('Form data restored from previous session', 'info');
                    }
                } catch (e) {
                    // Silent fail
                }
            }

            // Initialize Select2 for better mobile experience (if needed)
            if (typeof $.fn.select2 !== 'undefined') {
                $('.form-select').select2({
                    theme: 'bootstrap-5',
                    width: '100%',
                    dropdownParent: $('.modal-body')
                });
            }

            // Render calendar and load initial data
            calendar.render();
            loadEvents();

            // Show loading message initially
            showToast('Loading calendar data...', 'info');

            // Ensure proper initialization on window load
            $(window).on('load', function() {
                setTimeout(function() {
                    applyShiftBlocksToVisibleDates();
                    hideCalendarLoader();
                }, 100);
            });

            // Global error handler for AJAX requests
            $(document).ajaxError(function(event, xhr, settings, error) {
                console.error('AJAX Error:', error, xhr.responseText);
                showToast('Network error occurred. Please check your connection.', 'error');
                hideCalendarLoader();
            });

            // Keyboard shortcuts
            $(document).on('keydown', function(e) {
                // Ctrl/Cmd + N for new booking
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    openBookingModal();
                }

                // Escape to close modals
                if (e.key === 'Escape') {
                    $('.modal').modal('hide');
                }

                // Ctrl/Cmd + S to save (when modal is open)
                if ((e.ctrlKey || e.metaKey) && e.key === 's' && $('#bookingModal').hasClass('show')) {
                    e.preventDefault();
                    if (validateBookingForm()) {
                        saveBooking();
                    }
                }
            });

            // Add swipe gestures for mobile calendar navigation
            if (isMobile) {
                let startX = 0;
                let startY = 0;

                $('#calendar').on('touchstart', function(e) {
                    startX = e.originalEvent.touches[0].clientX;
                    startY = e.originalEvent.touches[0].clientY;
                });

                $('#calendar').on('touchend', function(e) {
                    if (!startX || !startY) return;

                    const endX = e.originalEvent.changedTouches[0].clientX;
                    const endY = e.originalEvent.changedTouches[0].clientY;

                    const diffX = startX - endX;
                    const diffY = startY - endY;

                    // Only process horizontal swipes that are significant
                    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                        if (diffX > 0) {
                            // Swipe left - next month
                            calendar.next();
                        } else {
                            // Swipe right - previous month
                            calendar.prev();
                        }
                    }

                    startX = 0;
                    startY = 0;
                });
            }

        });

        // Make saveBooking globally accessible for onclick handler
        window.saveBooking = function() {
            if (typeof $ !== 'undefined') {
                const validateFunc = $('#bookingFormFields')[0] ?
                    () => $('#bookingFormFields')[0].checkValidity() :
                    () => true;

                if (validateFunc()) {
                    // Call the saveBooking function defined in the jQuery document ready
                    $(document).trigger('saveBooking');
                }
            }
        };

        // Trigger save from global function
        $(document).on('saveBooking', function() {
            if (typeof validateBookingForm === 'function' && validateBookingForm()) {
                // The actual save logic is handled in the saveBooking function above
                $('#save-booking').trigger('click');
            }
        });
    </script>

</body>
</html>