<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Event Booking Pro</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #667eea;
            --primary-dark: #5a6fd8;
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fdbb2d 0%, #22c1c3 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --surface-color: #ffffff;
            --background-color: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #718096;
            --text-muted: #a0aec0;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --border-radius: 16px;
            --border-radius-sm: 8px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: var(--background-color);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            color: var(--text-primary);
            font-weight: 400;
        }

        /* Enhanced App Bar */
        .app-bar {
            background: var(--primary-gradient);
            color: white;
            padding: 1.5rem 1rem;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .app-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
            font-weight: 400;
            margin-top: 0.25rem;
        }

        /* Enhanced Floating Action Button */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 1.5rem;
            width: 64px;
            height: 64px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.75rem;
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

            .fab:hover, .fab:active {
                transform: scale(1.1) rotate(90deg);
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            }

        /* Enhanced Quick Actions */
        .quick-actions-container {
            padding: 1rem;
            margin-bottom: 0.5rem;
        }

        .quick-action {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.25rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-color);
            cursor: pointer;
        }

            .quick-action:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
                color: var(--text-primary);
                text-decoration: none;
            }

            .quick-action:active {
                transform: translateY(0);
                box-shadow: var(--shadow-sm);
            }

        .quick-action-icon {
            width: 56px;
            height: 56px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .quick-action-content h6 {
            margin: 0;
            font-weight: 600;
            font-size: 1rem;
        }

        .quick-action-content small {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Enhanced Calendar Container */
        .calendar-container {
            margin: 0 1rem 1rem 1rem;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        /* Enhanced FullCalendar Styles */
        .fc {
            font-size: 0.875rem;
            font-family: 'Inter', sans-serif;
        }

        .fc-toolbar {
            padding: 1.5rem;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .fc-toolbar-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            flex: 1;
            text-align: center;
        }

        .fc-button {
            background: var(--primary-gradient) !important;
            border: none !important;
            border-radius: 50% !important;
            width: 44px !important;
            height: 44px !important;
            padding: 0 !important;
            font-size: 1.1rem !important;
            box-shadow: var(--shadow-sm) !important;
            margin: 0 0.5rem !important;
            transition: all 0.3s ease !important;
        }

            .fc-button:hover, .fc-button:focus {
                transform: scale(1.05) !important;
                box-shadow: var(--shadow-md) !important;
            }

        .fc-daygrid-day {
            min-height: 80px !important;
            position: relative;
            border: 1px solid var(--border-color) !important;
            transition: background-color 0.2s ease;
        }

            .fc-daygrid-day:hover {
                background-color: rgba(102, 126, 234, 0.05);
            }

        .fc-daygrid-day-number {
            padding: 8px !important;
            font-weight: 600 !important;
            color: var(--text-primary) !important;
            font-size: 0.9rem !important;
        }

        .fc-day-today .fc-daygrid-day-number {
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 700;
            box-shadow: var(--shadow-sm);
        }

        /* Enhanced Shift Blocks */
        .shift-block {
            position: absolute;
            cursor: pointer;
            z-index: 10;
            border-radius: var(--border-radius-sm);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 24px;
            line-height: 1.1;
            text-align: center;
            box-shadow: var(--shadow-sm);
            padding: 4px 6px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            width: calc(100% - 4px);
        }

            .shift-block:hover {
                transform: scale(1.02);
                box-shadow: var(--shadow-md);
            }

            .shift-block:active {
                transform: scale(0.98);
            }

        .shift-morning {
            background: var(--warning-gradient);
        }

        .shift-evening {
            background: var(--success-gradient);
        }

        .shift-fullday {
            background: var(--secondary-gradient);
        }

        .shift-customer-name {
            font-size: 0.65rem;
            font-weight: 700;
            line-height: 1.1;
            margin: 0 0 2px 0;
            padding: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            text-align: center;
            max-width: 100%;
        }

        .shift-address {
            font-size: 0.6rem;
            font-weight: 500;
            line-height: 1.1;
            margin: 0;
            padding: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            text-align: center;
            max-width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            flex-wrap: wrap;
        }

            .shift-address i {
                font-size: 0.55rem;
                opacity: 0.9;
                flex-shrink: 0;
            }

        /* Enhanced Empty Shift Areas */
        .empty-shift-area {
            position: absolute;
            background: rgba(102, 126, 234, 0.1);
            border: 2px dashed rgba(102, 126, 234, 0.3);
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            width: calc(100% - 4px);
        }

            .empty-shift-area:hover {
                background: rgba(102, 126, 234, 0.15);
                border-color: var(--primary-color);
                transform: scale(1.02);
            }

            .empty-shift-area:active {
                background: rgba(102, 126, 234, 0.2);
                transform: scale(0.98);
            }

        /* Enhanced Modal Styles */
        .modal {
            z-index: 1200 !important;
        }

        .modal-backdrop {
            z-index: 1150 !important;
        }

        .modal-dialog {
            margin: 0;
            height: 100vh;
            max-width: 100%;
        }

        .modal-content {
            height: 100vh;
            border-radius: 0;
            border: none;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            background: var(--primary-gradient);
            color: white;
            padding: 1.5rem;
            border-bottom: none;
        }

        .modal-title {
            font-size: 1.375rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-close {
            filter: invert(1);
            opacity: 0.8;
            font-size: 1.25rem;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
            background: var(--background-color);
        }

        .modal-footer {
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 1.5rem;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced Form Styles */
        .form-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-control, .form-select {
            border-radius: var(--border-radius-sm);
            border: 2px solid var(--border-color);
            padding: 0.875rem 1rem;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--card-bg);
            font-weight: 500;
        }

            .form-control:focus, .form-select:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
                transform: translateY(-1px);
            }

        /* Enhanced Button Styles */
        .btn {
            border-radius: var(--border-radius);
            padding: 0.875rem 1.5rem;
            font-weight: 600;
            font-size: 0.95rem;
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: none;
            letter-spacing: 0.025em;
            position: relative;
            overflow: hidden;
        }

            .btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                transition: left 0.5s;
            }

            .btn:hover::before {
                left: 100%;
            }

        .btn-primary {
            background: var(--primary-gradient);
            box-shadow: var(--shadow-sm);
        }

            .btn-primary:hover, .btn-primary:active {
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }

        .btn-success {
            background: var(--success-gradient);
            box-shadow: var(--shadow-sm);
        }

        .btn-danger {
            background: var(--danger-gradient);
            box-shadow: var(--shadow-sm);
        }

        .btn-outline-success {
            border: 2px solid #4facfe;
            color: #4facfe;
            background: transparent;
        }

            .btn-outline-success:hover {
                background: var(--success-gradient);
                border-color: transparent;
            }

        /* Enhanced Detail Cards */
        .detail-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

            .detail-card:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }

        .detail-header {
            background: var(--primary-gradient);
            color: white;
            padding: 1rem 1.25rem;
            border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0;
            margin: -1.5rem -1.5rem 1.5rem -1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Enhanced Status Badges */
        .badge {
            font-weight: 600;
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius-sm);
            font-size: 0.75rem;
        }

        .bg-primary {
            background: var(--primary-gradient) !important;
        }

        /* Enhanced Loader */
        .loader-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(248, 250, 252, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: var(--border-radius);
            backdrop-filter: blur(4px);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @@keyframes spin {
            0%

        {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }

        }

        /* Enhanced Error Messages */
        .error-message {
            background: rgba(255, 107, 107, 0.1);
            color: #ee5a24;
            padding: 0.75rem;
            border-radius: var(--border-radius-sm);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            border-left: 4px solid #ee5a24;
            font-weight: 500;
        }

        /* Enhanced Toast Styling */
        .toast-container {
            position: fixed;
            bottom: 100px;
            left: 1rem;
            right: 1rem;
            z-index: 1100;
        }

        .toast {
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            margin-bottom: 0.75rem;
            border: none;
            backdrop-filter: blur(10px);
        }

        /* Enhanced Alert Styles */
        .alert {
            border-radius: var(--border-radius);
            border: none;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .alert-info {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary-color);
        }

        .alert-danger {
            background: rgba(255, 107, 107, 0.1);
            color: #ee5a24;
        }

        .alert-success {
            background: rgba(79, 172, 254, 0.1);
            color: #0891b2;
        }

        /* Small screen optimizations */
        @@media (max-width: 360px) {
            .fc-daygrid-day

        {
            min-height: 75px !important;
        }

        .shift-block {
            font-size: 0.7rem;
            min-height: 20px;
        }

        .quick-action-icon {
            width: 48px;
            height: 48px;
        }

        .fab {
            width: 56px;
            height: 56px;
            font-size: 1.5rem;
        }

        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }

        /* Enhanced focus states */
        *:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Smooth transitions for all interactive elements */
        .quick-action, .shift-block, .empty-shift-area, .btn, .form-control, .form-select {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Enhanced row styling */
        .row.mb-3 .col-6 .form-label,
        .row.mb-3 .col-4 .form-label,
        .row.mb-3 .col-8 .form-label {
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }

        /* Better spacing for form groups */
        .mb-3 {
            margin-bottom: 1.25rem !important;
        }

        /* Enhanced multi-booking modal content */
        #multi-booking-content .detail-card {
            cursor: pointer;
            border: 2px solid transparent;
        }

            #multi-booking-content .detail-card:hover {
                border-color: var(--primary-color);
                background: rgba(102, 126, 234, 0.05);
            }
    </style>
</head>
<body>
    <!-- Enhanced App Bar -->
    <div class="app-bar">
        <h1 class="app-title">
            <i class="bi bi-calendar-event"></i>
            Event Booking Pro
        </h1>
        <div class="app-subtitle">Manage your events seamlessly</div>
    </div>

    <!-- Enhanced Quick Actions -->
    <div class="quick-actions-container">
        <div class="quick-action" onclick="refreshCalendar()">
            <div class="quick-action-icon">
                <i class="bi bi-arrow-clockwise"></i>
            </div>
            <div class="quick-action-content">
                <h6>Refresh Calendar</h6>
                <small>Update and sync all events</small>
            </div>
        </div>
    </div>

    <!-- Enhanced Calendar -->
    <div class="calendar-container position-relative">
        <div id="calendar-loader" class="loader-overlay d-none">
            <div class="spinner"></div>
        </div>
        <div id="calendar"></div>
    </div>

    <!-- 🔥 FIXED: Removed generateDateWiseShifts() from FAB button -->
    <button class="fab" onclick="openBookingModal()" aria-label="Add new booking">
        <i class="bi bi-plus"></i>
    </button>

    <!-- Enhanced Booking Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="modal-title-text" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-calendar-plus"></i>
                        <span id="modal-title-text">New Booking</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="modal-message" class="alert d-none"></div>

                    <form id="bookingForm" novalidate>
                        <input type="hidden" id="bookingId">
                        <input type="hidden" id="userId" value="1">

                        <div class="mb-3">
                            <label for="EventName" class="form-label">
                                <i class="bi bi-star me-1"></i>Event Name *
                            </label>
                            <input type="text" id="EventName" class="form-control" placeholder="Wedding, Birthday, Corporate Event..." required>
                        </div>

                        <div class="mb-3">
                            <label for="customerName" class="form-label">
                                <i class="bi bi-person me-1"></i>Customer Name *
                            </label>
                            <input type="text" id="customerName" class="form-control" placeholder="Enter customer name" required>
                        </div>

                        <div class="row mb-3">
                            <div class="col-8">
                                <label for="phoneNumber" class="form-label">
                                    <i class="bi bi-telephone me-1"></i>Phone Number *
                                </label>
                                <input type="tel" id="phoneNumber" class="form-control" placeholder="10 digit number" required>
                            </div>
                            <div class="col-4">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-outline-success w-100" onclick="openWhatsApp()">
                                    <i class="bi bi-whatsapp"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="alternativeNumber" class="form-label">
                                <i class="bi bi-telephone-plus me-1"></i>Alternative Number
                            </label>
                            <input type="tel" id="alternativeNumber" class="form-control" placeholder="Optional backup number">
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="fromDate" class="form-label">
                                    <i class="bi bi-calendar-date me-1"></i>From Date *
                                </label>
                                <input type="date" id="fromDate" class="form-control" required>
                            </div>
                            <div class="col-6">
                                <label for="toDate" class="form-label">
                                    <i class="bi bi-calendar-check me-1"></i>To Date *
                                </label>
                                <input type="date" id="toDate" class="form-control" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="bookingStatus" class="form-label">
                                    <i class="bi bi-check-circle me-1"></i>Status *
                                </label>
                                <select id="bookingStatus" class="form-select" required>
                                    <option value="Confirmed">✅ Confirmed</option>
                                    <option value="Pending">⏳ Pending</option>
                                    <option value="Cancelled">❌ Cancelled</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label for="paymentStatus" class="form-label">
                                    <i class="bi bi-currency-rupee me-1"></i>Payment *
                                </label>
                                <select id="paymentStatus" class="form-select" required>
                                    <option value="Paid">💰 Paid</option>
                                    <option value="Partially Paid">💳 Partial</option>
                                    <option value="Pending">⏰ Pending</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-4">
                                <label for="totalAmount" class="form-label">Total ₹ *</label>
                                <input type="number" id="totalAmount" class="form-control" placeholder="0" required>
                            </div>
                            <div class="col-4">
                                <label for="advancePayment" class="form-label">Advance ₹</label>
                                <input type="number" id="advancePayment" class="form-control" placeholder="0">
                            </div>
                            <div class="col-4">
                                <label for="remainingPayment" class="form-label">Balance ₹</label>
                                <input type="number" id="remainingPayment" class="form-control" readonly>
                            </div>
                        </div>
                        <div class="row mb-5">
                            <div class="col-4">
                                <label for="diesel" class="form-label">Diesel ₹ *</label>
                                <input type="text" id="diesel" class="form-control" placeholder="0" required>
                            </div>
                            <div class="col-8">
                                <label for="bandType" class="form-label">BandType </label>
                                <input type="text" id="bandType" class="form-control">
                            </div>

                        </div>

                        <div class="mb-3">
                            <label for="address" class="form-label">
                                <i class="bi bi-geo-alt me-1"></i>Event Address
                            </label>
                            <textarea id="address" class="form-control" rows="3" placeholder="Enter complete event location with landmarks..."></textarea>
                        </div>

                        <div class="date-block" id="dateWiseShiftContainer">
                            <!-- Dynamic shift selection will appear here -->
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="delete-booking" style="display:none;">
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                    <button type="button" class="btn btn-primary flex-fill" onclick="saveBooking()">
                        <i class="bi bi-save me-1"></i> Save Booking
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="details-title" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle"></i>
                        <span id="details-title">Booking Details</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="booking-details-content">
                    <!-- Booking details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success me-2" id="whatsapp-btn">
                        <i class="bi bi-whatsapp me-1"></i> WhatsApp
                    </button>
                    <button type="button" class="btn btn-primary flex-fill" id="edit-booking-btn">
                        <i class="bi bi-pencil me-1"></i> Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Multi-booking Modal -->
    <div class="modal fade" id="multiBookingModal" tabindex="-1" aria-labelledby="multiBookingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="multiBookingModalLabel">
                        <i class="bi bi-list"></i>
                        Multiple Bookings
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="multi-booking-content">
                    <!-- Multiple booking options will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
            // Enhanced event booking calendar with improved UI and optimized data loading
        let shiftMap = {};
        let calendar;
        const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
        const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
        const multiBookingModal = new bootstrap.Modal(document.getElementById('multiBookingModal'));

        // Optimized data loading variables
        let isLoading = false;
        let loadingTimeout;
        let cachedBookings = null;
        let lastLoadTime = 0;
        const CACHE_DURATION = 30000; // 30 seconds cache

        // Utility functions
        function localYMD(date) {
            const Y = date.getFullYear();
            const M = String(date.getMonth() + 1).padStart(2, '0');
            const D = String(date.getDate()).padStart(2, '0');
            return `${Y}-${M}-${D}`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '—';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function showToast(message, type = 'info') {
            // Enhanced toast with better styling
            const toastId = 'toast-' + Date.now();
            const iconMap = {
                success: 'bi-check-circle-fill',
                error: 'bi-exclamation-triangle-fill',
                info: 'bi-info-circle-fill',
                warning: 'bi-exclamation-triangle-fill'
            };

            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed d-flex align-items-center`;
            toast.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                animation: slideInRight 0.3s ease-out;
            `;

            toast.innerHTML = `
                <i class="bi ${iconMap[type] || iconMap.info} me-2"></i>
                <span class="flex-grow-1">${message}</span>
                <button type="button" class="btn-close" onclick="removeToast('${toastId}')"></button>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                removeToast(toastId);
            }, 4000);
        }

        function removeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (toast.parentNode) toast.parentNode.removeChild(toast);
                }, 300);
            }
        }

        function showLoader() {
            document.getElementById('calendar-loader').classList.remove('d-none');
        }

        function hideLoader() {
            document.getElementById('calendar-loader').classList.add('d-none');
        }
                function createShiftBlock(shiftType, bookings, dateStr) {
            const div = document.createElement('div');
            div.className = `shift-block shift-${shiftType.replace(' ', '')}`;

            // Show only PLACE NAME and EVENT NAME (NO icons, NO dates)
            if (bookings[0] && bookings[0].fullBookingData) {
                const data = bookings[0].fullBookingData;

                // 1. Event name (first priority) - NO icons
                if (data.eventName && data.eventName.trim()) {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'shift-customer-name'; // Reusing existing CSS class

                    // Truncate long event names
                    let eventName = data.eventName.trim();
                    if (eventName.length > 20) {
                        eventName = eventName.substring(0, 17) + '...';
                    }

                    eventDiv.innerHTML = eventName; // NO icons, just text
                    div.appendChild(eventDiv);
                }

                // 2. Place/Address (second priority) - NO icons
                if (data.address && data.address.trim()) {
                    const addressDiv = document.createElement('div');
                    addressDiv.className = 'shift-address';

                    // Clean up address - get first meaningful part (place/location)
                    let cleanAddress = data.address.split(',')[0].trim();

                    // If the first part is too long, take first few words
                    if (cleanAddress.length > 20) {
                        cleanAddress = cleanAddress.split(' ').slice(0, 2).join(' ') + '...';
                    }

                    addressDiv.innerHTML = cleanAddress; // NO icons, just place name
                    div.appendChild(addressDiv);
                }

                // 3. Fallback: If no event name, show shift type only (no icons)
                if (!data.eventName || !data.eventName.trim()) {
                    const fallbackDiv = document.createElement('div');
                    fallbackDiv.className = 'shift-customer-name';
                    fallbackDiv.innerHTML = `${capitalizeFirstLetter(shiftType)} Shift`; // NO icons
                    div.appendChild(fallbackDiv);
                }
            }

            div.onclick = function (e) {
                e.stopPropagation();
                handleDateClick(dateStr);
            };

            // Simple hover tooltip without icons
            const eventName = bookings[0]?.fullBookingData?.eventName || 'Event';
            const place = bookings[0]?.fullBookingData?.address?.split(',')[0] || 'Location';

            div.setAttribute('title', `${eventName} - ${place}\nClick to view details`);

            return div;
        }


        function addEmptyShiftArea(cell, shiftType, dateStr) {
            const area = document.createElement('div');
            area.className = 'empty-shift-area';

            const position = shiftType === 'morning' ?
                { top: '32px', height: '50%', left: '2px', right: '2px' } :
                { bottom: '2px', height: '50%', left: '2px', right: '2px' };

            Object.assign(area.style, position);

            // Show shift icon with plus
            const shiftIcons = {
                'morning': '🌅',
                'evening': '🌆'
            };

            const content = document.createElement('div');
            content.innerHTML = `${shiftIcons[shiftType]} <i class="bi bi-plus-circle ms-1"></i>`;
            content.style.fontSize = '1rem';
            area.appendChild(content);

            area.onclick = function(e) {
                e.stopPropagation();
                openBookingModal(dateStr, [shiftType]);
            };

            area.setAttribute('title', `${shiftIcons[shiftType]} Add ${shiftType} shift`);
            return area;
        }

        // Enhanced shift block rendering
               // Updated renderShiftBlocks function - WITHOUT empty shift areas
              function renderShiftBlocks(arg) {
            const dateStr = localYMD(arg.date);
            const shifts = shiftMap[dateStr] || [];
            if (!shifts.length) return; // No shifts, show nothing (no empty areas)
            const cell = arg.el;
            cell.style.position = 'relative';
            const POSITIONS = {
                'full day': { top: '32px', height: 'calc(100% - 36px)', left: '2px', right: '2px' },
                'morning': { top: '-2px', height: '50%', left: '2px', right: '2px' },
                'evening': { bottom: '2px', height: '50%', left: '2px', right: '2px' }
            };
            const byType = shifts.reduce((acc, s) => {
                (acc[s.shift] = acc[s.shift] || []).push(s);
                return acc;
            }, {});

            const hasFull = byType['full day'];
            const hasMorn = byType['morning'];
            const hasEven = byType['evening'];

            // Empty shift areas creation
            if (!hasFull && (hasMorn || hasEven)) {
                if (hasMorn && !hasEven) {
                    const emptyArea = addEmptyShiftArea(cell, 'evening', dateStr);
                    Object.assign(emptyArea.style, POSITIONS['evening']);
                    cell.appendChild(emptyArea);
                } else if (!hasMorn && hasEven) {
                    const emptyArea = addEmptyShiftArea(cell, 'morning', dateStr);
                    Object.assign(emptyArea.style, POSITIONS['morning']);
                    cell.appendChild(emptyArea);
                }
            }

            // Only render existing shift blocks (actual bookings)
            Object.entries(byType).forEach(([type, list]) => {
                const block = createShiftBlock(type, list, dateStr);
                Object.assign(block.style, POSITIONS[type]);

                // Enhanced colors for better visibility
                if (type === 'morning') {
                    block.style.background = 'linear-gradient(135deg, #FF6B35 0%, #F7931E 100%)'; // Orange gradient
                    block.style.border = '2px solid #FF6B35';
                    block.style.boxShadow = '0 2px 8px rgba(255, 107, 53, 0.3)';
                } else if (type === 'evening') {
                    block.style.background = 'linear-gradient(135deg, #4A90E2 0%, #357ABD 100%)'; // Blue gradient
                    block.style.border = '2px solid #4A90E2';
                    block.style.boxShadow = '0 2px 8px rgba(74, 144, 226, 0.3)';
                } else if (type === 'full day') {
                    block.style.background = 'linear-gradient(135deg, #7B68EE 0%, #9370DB 100%)'; // Purple gradient
                    block.style.border = '2px solid #7B68EE';
                    block.style.boxShadow = '0 2px 8px rgba(123, 104, 238, 0.3)';
                }

                // Add address display
                const bookingData = list[0]?.fullBookingData;
          

                cell.appendChild(block);
            });
        }

        function openNewBookingModal() {
            document.getElementById('bookingForm').reset();
            document.getElementById('bookingId').value = 0;
            document.getElementById('userId').value = 1;
            document.getElementById('modal-title-text').textContent = 'New Booking';

            // Set today's date if no specific date is provided
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fromDate').value = today;
            document.getElementById('toDate').value = today;

            // Generate shifts for default dates
            generateDateWiseShifts();

            bookingModal.show();
        }

        // Enhanced date click handling
        function handleDateClick(dateStr) {
            const shifts = shiftMap[dateStr] || [];
            const bookedShiftTypes = shifts.map(s => s.shift);
            const hasMorning = bookedShiftTypes.includes('morning');
            const hasEvening = bookedShiftTypes.includes('evening');
            const hasFullDay = bookedShiftTypes.includes('full day');

            // Set the clicked date in the form
            document.getElementById('fromDate').value = dateStr;
            document.getElementById('toDate').value = dateStr;

            if (hasFullDay || (hasMorning && hasEvening) || shifts.length > 1) {
                showMultipleBookings(dateStr, shifts);
                return;
            }

            if ((hasMorning && !hasEvening) || (!hasMorning && hasEvening)) {
                const availableShifts = [];
                if (hasMorning) availableShifts.push('evening');
                if (hasEvening) availableShifts.push('morning');
                showPartialBookingOptions(dateStr, shifts, availableShifts);
                return;
            }

            openBookingModal(dateStr);
        }

        function showPartialBookingOptions(dateStr, existingBookings, availableShifts) {
            const formattedDate = formatDate(dateStr);

            let content = `
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>${formattedDate}</strong> has partial bookings. Choose an option below:
                </div>

                <div class="mb-4">
                    <h6 class="text-primary mb-3">
                        <i class="bi bi-calendar-check me-2"></i>Existing Bookings
                    </h6>`;

            existingBookings.forEach((booking, index) => {
                const data = booking.fullBookingData;
                const shiftIcon = booking.shift === 'morning' ? '🌅' : '🌆';
                const statusColor = data.bookingStatus === 'Confirmed' ? 'success' :
                                  data.bookingStatus === 'Pending' ? 'warning' : 'danger';

                content += `
                    <div class="detail-card mb-3" onclick="selectExistingBooking(${index})" style="cursor: pointer;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="me-2">${shiftIcon}</span>
                                    <strong>${data.eventName || 'Event'}</strong>
                                </div>
                                <div class="text-muted small">
                                    <i class="bi bi-person me-1"></i>${data.customerName || 'Customer'}
                                </div>
                                <div class="text-muted small">
                                    <i class="bi bi-telephone me-1"></i>${data.phoneNumber || 'No phone'}
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-${statusColor} mb-1">${capitalizeFirstLetter(booking.shift)}</span>
                                <br><small class="text-success fw-bold">₹${data.totalAmount || 0}</small>
                            </div>
                        </div>
                    </div>
                `;
            });

            content += `</div>`;

            if (availableShifts.length > 0) {
                content += `
                    <div class="mb-3">
                        <h6 class="text-success mb-3">
                            <i class="bi bi-plus-circle me-2"></i>Available Shifts
                        </h6>
                        <div class="d-grid gap-2">`;

                availableShifts.forEach(shift => {
                    const shiftIcon = shift === 'morning' ? '🌅' : '🌆';
                    const shiftLabel = shift === 'morning' ? 'Morning Shift' : 'Evening Shift';

                    content += `
                        <button class="btn btn-outline-success btn-lg d-flex align-items-center justify-content-center"
                                onclick="bookAvailableShift('${dateStr}', '${shift}')">
                            <span class="me-2">${shiftIcon}</span>
                            Book ${shiftLabel}
                            <i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    `;
                });
                content += `</div></div>`;
            }

            document.getElementById('multi-booking-content').innerHTML = content;
            window._existingBookings = existingBookings;
            multiBookingModal.show();
        }

        window.selectExistingBooking = function(index) {
            multiBookingModal.hide();
            const booking = window._existingBookings[index];
            viewBookingDetails(booking.fullBookingData);
        };

        window.bookAvailableShift = function(dateStr, shift) {
            multiBookingModal.hide();
            openBookingModal(dateStr, [shift]);
        };

        function showMultipleBookings(dateStr, bookings) {
            const formattedDate = formatDate(dateStr);

            let content = `
                <div class="alert alert-primary mb-4">
                    <i class="bi bi-calendar-event me-2"></i>
                    <strong>${formattedDate}</strong> - ${bookings.length} booking(s)
                </div>
            `;

            bookings.forEach((booking, index) => {
                const data = booking.fullBookingData;
                const shiftIcons = {
                    'morning': '🌅',
                    'evening': '🌆',
                    'full day': '🌟'
                };

                const statusColors = {
                    'Confirmed': 'success',
                    'Pending': 'warning',
                    'Cancelled': 'danger'
                };

                const paymentColors = {
                    'Paid': 'success',
                    'Partially Paid': 'warning',
                    'Pending': 'secondary'
                };

                content += `
                    <div class="detail-card mb-3" onclick="selectBooking(${index})" style="cursor: pointer;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="me-2 fs-5">${shiftIcons[booking.shift] || '📅'}</span>
                                    <h6 class="mb-0 fw-bold">${data.eventName || 'Event'}</h6>
                                </div>

                                <div class="mb-2">
                                    <div class="text-muted small mb-1">
                                        <i class="bi bi-person-fill me-1"></i>${data.customerName || 'Customer'}
                                    </div>
                                    <div class="text-muted small">
                                        <i class="bi bi-telephone-fill me-1"></i>${data.phoneNumber || 'No phone'}
                                    </div>
                                </div>

                                <div class="d-flex gap-2 flex-wrap">
                                    <span class="badge bg-${statusColors[data.bookingStatus] || 'secondary'}">${data.bookingStatus || 'Unknown'}</span>
                                    <span class="badge bg-${paymentColors[data.paymentStatus] || 'secondary'}">${data.paymentStatus || 'Unknown'}</span>
                                </div>
                            </div>

                            <div class="text-end ms-3">
                                <div class="badge bg-primary mb-2 px-3">${capitalizeFirstLetter(booking.shift)}</div>
                                <div class="fw-bold text-success">₹${(data.totalAmount || 0).toLocaleString()}</div>
                                <small class="text-muted">Total Amount</small>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('multi-booking-content').innerHTML = content;
            window._multiBookingData = bookings;
            multiBookingModal.show();
        }

        window.selectBooking = function(index) {
            multiBookingModal.hide();
            const booking = window._multiBookingData[index];
            viewBookingDetails(booking.fullBookingData);
        };

        // Enhanced booking details view
        function viewBookingDetails(booking) {
            const statusIcons = {
                'Confirmed': '✅',
                'Pending': '⏳',
                'Cancelled': '❌'
            };

            const paymentIcons = {
                'Paid': '💰',
                'Partially Paid': '💳',
                'Pending': '⏰'
            };

            // Extract shift details from dateWiseShifts
            let shiftDetailsHTML = '';
            if (booking.dateWiseShifts) {
                try {
                    const shiftsData = JSON.parse(booking.dateWiseShifts);
                    const shiftIcons = {
                        'morning': '🌅',
                        'evening': '🌆',
                        'full day': '🌟'
                    };

                    shiftDetailsHTML = `
                        <div class="col-12">
                            <div class="fw-medium text-muted mb-2">Shift Details</div>
                            <div class="bg-light p-3 rounded">`;

                    Object.keys(shiftsData).forEach(dateStr => {
                        const dayShifts = shiftsData[dateStr];
                        const formattedDate = formatDate(dateStr);

                        shiftDetailsHTML += `<div class="mb-2"><strong>${formattedDate}:</strong><br>`;

                        dayShifts.forEach(shift => {
                            const icon = shiftIcons[shift.shift] || '📅';
                            const shiftName = capitalizeFirstLetter(shift.shift);
                            shiftDetailsHTML += `
                                <span class="badge bg-primary me-2 mb-1">
                                    ${icon} ${shiftName}: ${shift.startTime} - ${shift.endTime}
                                </span>
                            `;
                        });

                        shiftDetailsHTML += `</div>`;
                    });

                    shiftDetailsHTML += `</div></div>`;
                } catch (error) {
                    console.error('Error parsing shift details:', error);
                    shiftDetailsHTML = `
                        <div class="col-12">
                            <div class="fw-medium text-muted mb-1">Shift Type</div>
                            <div class="fw-bold">${capitalizeFirstLetter(booking.shiftType || 'Not specified')}</div>
                        </div>
                    `;
                }
            } else if (booking.shiftType) {
                shiftDetailsHTML = `
                    <div class="col-12">
                        <div class="fw-medium text-muted mb-1">Shift Type</div>
                        <div class="fw-bold">${capitalizeFirstLetter(booking.shiftType)}</div>
                    </div>
                `;
            }

            const content = `
                <div class="detail-card">
                    <div class="detail-header">
                        <i class="bi bi-calendar-event"></i>Event Information
                    </div>

                    <div class="row g-3">
                        <div class="col-12">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="fw-medium text-muted">Event Name</div>
                                <div class="fw-bold">${booking.eventName || '—'}</div>
                            </div>
                        </div>

                        <div class="col-6">
                            <div class="fw-medium text-muted mb-1">From Date</div>
                            <div class="fw-bold">${formatDate(booking.fromDate)}</div>
                        </div>

                        <div class="col-6">
                            <div class="fw-medium text-muted mb-1">To Date</div>
                            <div class="fw-bold">${formatDate(booking.toDate)}</div>
                        </div>

                        ${shiftDetailsHTML}

                        <div class="col-6">
                            <div class="fw-medium text-muted mb-1">Band Type</div>
                            <div class="fw-bold">${booking.bandType || '—'}</div>
                        </div>

                        <div class="col-6">
                            <div class="fw-medium text-muted mb-1">Diesel</div>
                            <div class="fw-bold">${booking.diesel || '—'}</div>
                        </div>

                        <div class="col-6">
                            <div class="fw-medium text-muted mb-1">Status</div>
                            <span class="badge bg-success">${statusIcons[booking.bookingStatus] || ''} ${booking.bookingStatus}</span>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <div class="detail-header">
                        <i class="bi bi-person-circle"></i>Customer Details
                    </div>

                    <div class="row g-3">
                        <div class="col-12">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="fw-medium text-muted">Customer Name</div>
                                <div class="fw-bold">${booking.customerName || '—'}</div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="fw-medium text-muted">Primary Phone</div>
                                <a href="tel:${booking.phoneNumber}" class="fw-bold text-decoration-none text-primary">
                                    <i class="bi bi-telephone-fill me-1"></i>${booking.phoneNumber || '—'}
                                </a>
                            </div>
                        </div>

                        ${booking.alternativeNumber ? `
                        <div class="col-12">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="fw-medium text-muted">Alternative Phone</div>
                                <a href="tel:${booking.alternativeNumber}" class="fw-bold text-decoration-none text-primary">
                                    <i class="bi bi-telephone-plus-fill me-1"></i>${booking.alternativeNumber}
                                </a>
                            </div>
                        </div>
                        ` : ''}

                        ${booking.address ? `
                        <div class="col-12">
                            <div class="fw-medium text-muted mb-2">Event Address</div>
                            <div class="bg-light p-3 rounded">
                                <i class="bi bi-geo-alt-fill text-primary me-2"></i>${booking.address}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <div class="detail-card">
                    <div class="detail-header">
                        <i class="bi bi-currency-rupee"></i>Payment Information
                    </div>

                    <div class="row g-3">
                        <div class="col-4">
                            <div class="text-center">
                                <div class="fw-medium text-muted mb-1">Total Amount</div>
                                <div class="h5 fw-bold text-primary mb-0">₹${(booking.totalAmount || 0).toLocaleString()}</div>
                            </div>
                        </div>

                        <div class="col-4">
                            <div class="text-center">
                                <div class="fw-medium text-muted mb-1">Advance Paid</div>
                                <div class="h5 fw-bold text-success mb-0">₹${(booking.advancePayment || 0).toLocaleString()}</div>
                            </div>
                        </div>

                        <div class="col-4">
                            <div class="text-center">
                                <div class="fw-medium text-muted mb-1">Balance Due</div>
                                <div class="h5 fw-bold text-warning mb-0">₹${(booking.remainingPayment || 0).toLocaleString()}</div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="text-center">
                                <span class="badge bg-info px-4 py-2">
                                    ${paymentIcons[booking.paymentStatus] || ''} ${booking.paymentStatus || 'Unknown'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('booking-details-content').innerHTML = content;
            document.getElementById('details-title').textContent = booking.eventName || 'Booking Details';

            document.getElementById('edit-booking-btn').onclick = function () {
                detailsModal.hide();
                openBookingModalForEdit(booking);
            };

            document.getElementById('whatsapp-btn').onclick = function () {
                sendWhatsAppMessage(booking);
            };

            detailsModal.show();
        }

        // Debounced load function to prevent multiple simultaneous calls
        function debouncedLoadEvents(delay = 500) {
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
            }

            loadingTimeout = setTimeout(() => {
                loadEvents(false); // false = don't force reload if cache is fresh
            }, delay);
        }

        // Enhanced loadEvents with caching
        function loadEvents(forceReload = false) {
            const now = Date.now();

            // Check if we have fresh cached data
            if (!forceReload && cachedBookings && (now - lastLoadTime) < CACHE_DURATION) {
                console.log('📦 Using cached data');
                renderCachedEvents();
                return;
            }

            // Prevent multiple simultaneous requests
            if (isLoading) {
                console.log('⏳ Already loading, skipping duplicate request');
                return;
            }

            isLoading = true;
            showLoader();

            console.log('🔄 Loading fresh data from server...');

            $.ajax({
                url: '/EventBooking/GetAllEventBookings',
                type: 'GET',
                timeout: 15000, // Increased timeout
                cache: false // Prevent browser caching issues
            }).done(function(bookings) {
                // Cache the fresh data
                cachedBookings = bookings;
                lastLoadTime = now;

                processAndRenderEvents(bookings);

                hideLoader();
                isLoading = false;

                // Only show success message for manual refreshes
                if (forceReload) {
                    showToast(`✅ Refreshed ${bookings.length} booking(s)`, 'success');
                }

                console.log(`📊 Loaded ${bookings.length} bookings successfully`);

            }).fail(function(xhr, status, error) {
                console.error('❌ Failed to load bookings:', error);

                // Use cached data as fallback if available
                if (cachedBookings && cachedBookings.length > 0) {
                    console.log('📦 Using cached data as fallback');
                    renderCachedEvents();
                    showToast('⚠️ Using cached data - connection issue', 'warning');
                } else {
                    let errorMessage = 'Failed to load bookings';
                    if (status === 'timeout') {
                        errorMessage = 'Request timeout - please check your connection';
                    } else if (xhr.status === 404) {
                        errorMessage = 'Booking service not found';
                    } else if (xhr.status >= 500) {
                        errorMessage = 'Server error - please try again later';
                    }
                    showToast(errorMessage, 'error');
                }

                hideLoader();
                isLoading = false;
            });
        }

        // Render cached events without server call
        function renderCachedEvents() {
            if (cachedBookings) {
                processAndRenderEvents(cachedBookings);
            }
        }

        // Separate function to process and render events
        function processAndRenderEvents(bookings) {
            shiftMap = {};
            const bgEvents = [];

            bookings.forEach(function(booking) {
                const from = booking.fromDate ? new Date(booking.fromDate) : new Date(booking.createdDate);
                const to = booking.toDate ? new Date(booking.toDate) : from;

                from.setHours(0, 0, 0, 0);
                to.setHours(0, 0, 0, 0);

                const parsedShifts = booking.dateWiseShifts ? JSON.parse(booking.dateWiseShifts) : {};
                const defaultShift = booking.shiftType ? [booking.shiftType.toLowerCase()] : ['full day'];

                for (let d = new Date(from); d <= to; d.setDate(d.getDate() + 1)) {
                    const key = localYMD(d);
                    const dayShifts = parsedShifts[key] || defaultShift;

                    dayShifts.forEach(function(item) {
                        const shiftName = (typeof item === 'string' ? item : item.shift).toLowerCase();
                        if (['morning', 'evening', 'full day'].includes(shiftName)) {
                            shiftMap[key] = shiftMap[key] || [];
                            shiftMap[key].push({
                                shift: shiftName,
                                fullBookingData: booking
                            });
                        }
                    });
                }

                const bgStart = new Date(from);
                const bgEnd = new Date(to);
                bgEnd.setDate(bgEnd.getDate() + 1);

                bgEvents.push({
                    id: booking.bookingId,
                    start: localYMD(bgStart),
                    end: localYMD(bgEnd),
                    display: 'background',
                    backgroundColor: 'transparent'
                });
            });

            // Clear and re-render calendar events
            calendar.removeAllEvents();
            bgEvents.forEach(e => calendar.addEvent(e));
            
            // Manually render shift blocks on all visible day cells
            renderAllShiftBlocks();
        }
        
        // Function to manually render shift blocks on all visible cells
        function renderAllShiftBlocks() {
            const dayCells = document.querySelectorAll('.fc-daygrid-day');
            dayCells.forEach(cell => {
                const dateStr = cell.getAttribute('data-date');
                if (dateStr && shiftMap[dateStr]) {
                    // Clear existing shift blocks
                    const existingBlocks = cell.querySelectorAll('.shift-block, .empty-shift-area');
                    existingBlocks.forEach(block => block.remove());
                    
                    // Render new shift blocks
                    renderShiftBlocks({ date: new Date(dateStr), el: cell });
                }
            });
        }

        // Smart refresh function
        window.refreshCalendar = function() {
            console.log('🔄 Manual refresh requested');
            showToast('🔄 Refreshing calendar...', 'info');
            loadEvents(true); // Force reload
        };

        // Invalidate cache when data changes
        function invalidateCache() {
            cachedBookings = null;
            lastLoadTime = 0;
            console.log('🗑️ Cache invalidated');
        }

        // Enhanced calendar initialization with optimized loading
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 'auto',
                headerToolbar: {
                    left: 'prev',
                    center: 'title',
                    right: 'next'
                },

                dateClick(info) {
                    const target = info.jsEvent.target;
                    const isShiftBlock = target.closest('.shift-block');
                    const isEmptyArea = target.closest('.empty-shift-area');

                    if (!isShiftBlock && !isEmptyArea) {
                        handleDateClick(info.dateStr);
                    }
                },

                dayCellDidMount(arg) {
                    renderShiftBlocks(arg);
                },

                // OPTIMIZED: Only load on initial render and month changes
                datesSet(dateInfo) {
                    console.log('📅 Calendar view changed:', dateInfo.view.type);

                    // Only load data if we don't have fresh cached data
                    const now = Date.now();
                    if (!cachedBookings || (now - lastLoadTime) > CACHE_DURATION) {
                        debouncedLoadEvents(300); // Debounced loading with shorter delay
                    } else {
                        console.log('📦 Using cached data for view change');
                        renderCachedEvents();
                    }
                },

                // Enhanced loading state
                loading(isLoading) {
                    if (isLoading) {
                        showLoader();
                    } else {
                        hideLoader();
                    }
                }
            });

            calendar.render();

            // Initial load
            loadEvents(true);
        }

        // Enhanced booking modal functions
        window.openBookingModal = function(dateStr = '', availableShifts = null) {
            resetBookingForm();

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fromDate').value = dateStr || today;
            document.getElementById('toDate').value = dateStr || today;

            if (availableShifts) {
                const shiftSelect = document.getElementById('shiftType');
                if (shiftSelect) {
                    Array.from(shiftSelect.options).forEach(option => {
                        option.disabled = !availableShifts.includes(option.value);
                    });
                    if (availableShifts.length > 0) {
                        shiftSelect.value = availableShifts[0];
                    }
                }
            }

            document.getElementById('modal-title-text').textContent = 'New Booking';
            document.getElementById('delete-booking').style.display = 'none';

            // Generate shifts IMMEDIATELY when modal opens
            generateDateWiseShifts();

            bookingModal.show();
        };

        function resetBookingForm() {
            document.getElementById('bookingForm').reset();
            document.getElementById('bookingId').value = '';
            document.getElementById('userId').value = '1';
            document.querySelectorAll('.error-message').forEach(el => el.remove());
            document.getElementById('modal-message').classList.add('d-none');
        }

        function calculateRemainingPayment() {
            const total = parseFloat(document.getElementById('totalAmount').value) || 0;
            const advance = parseFloat(document.getElementById('advancePayment').value) || 0;
            const remaining = Math.max(0, total - advance);

            document.getElementById('remainingPayment').value = remaining.toFixed(2);

            const paymentStatus = document.getElementById('paymentStatus');
            if (total === 0) {
                paymentStatus.value = 'Pending';
            } else if (remaining <= 0) {
                paymentStatus.value = 'Paid';
            } else if (advance > 0) {
                paymentStatus.value = 'Partially Paid';
            } else {
                paymentStatus.value = 'Pending';
            }
        }

        // Enhanced save booking with cache invalidation
        window.saveBooking = function() {
            if (!validateForm()) return;

            const saveBtn = document.querySelector('[onclick="saveBooking()"]');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Saving...';
            saveBtn.disabled = true;

            // Collect dynamic date-wise shift data (only for checked shifts)
            const dateWiseShifts = {};
            const container = document.getElementById('dateWiseShiftContainer');
            const checkedBoxes = container.querySelectorAll('.shift-checkbox:checked');

            checkedBoxes.forEach(checkbox => {
                const dateStr = checkbox.dataset.date;
                const shiftType = checkbox.dataset.shift;

                const startInput = container.querySelector(`input[name="shift-${dateStr}-${shiftType}-start"]`);
                const endInput = container.querySelector(`input[name="shift-${dateStr}-${shiftType}-end"]`);

                if (startInput && endInput && startInput.value && endInput.value) {
                    if (!dateWiseShifts[dateStr]) {
                        dateWiseShifts[dateStr] = [];
                    }

                    dateWiseShifts[dateStr].push({
                        shift: shiftType,
                        startTime: startInput.value,
                        endTime: endInput.value
                    });
                }
            });

            const formData = {
                bookingId: document.getElementById('bookingId').value || 0,
                userId: document.getElementById('userId').value || 1,
                EventName: document.getElementById('EventName').value,
                customerName: document.getElementById('customerName').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                alternativeNumber: document.getElementById('alternativeNumber').value,
                fromDate: document.getElementById('fromDate').value,
                toDate: document.getElementById('toDate').value,
                bookingStatus: document.getElementById('bookingStatus').value,
                paymentStatus: document.getElementById('paymentStatus').value,
                totalAmount: parseFloat(document.getElementById('totalAmount').value) || 0,
                advancePayment: parseFloat(document.getElementById('advancePayment').value) || 0,
                remainingPayment: parseFloat(document.getElementById('remainingPayment').value) || 0,
                address: document.getElementById('address').value,
                dateWiseShifts: JSON.stringify(dateWiseShifts),
                bandType: document.getElementById('bandType').value,
                diesel: document.getElementById('diesel').value
            };

            const messageEl = document.getElementById('modal-message');
            messageEl.className = 'alert alert-info d-flex align-items-center';
            messageEl.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving booking...';
            messageEl.classList.remove('d-none');

            $.ajax({
                url: '/EventBooking/AddOrUpdateEventBooking',
                type: 'POST',
                data: { eventBooking: formData },
                success: function(response) {
                    if (response.success) {
                        showToast('🎉 Booking saved successfully!', 'success');
                        bookingModal.hide();

                        // OPTIMIZED: Invalidate cache and reload once
                        invalidateCache();
                        loadEvents(true);
                    } else {
                        messageEl.className = 'alert alert-danger d-flex align-items-center';
                        messageEl.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${response.message || 'Error saving booking'}`;
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Save booking error:', error);
                    let errorMessage = 'Failed to save booking. Please try again.';
                    if (status === 'timeout') {
                        errorMessage = 'Request timeout - please check your connection and try again.';
                    } else if (xhr.status >= 500) {
                        errorMessage = 'Server error - please try again later.';
                    }
                    messageEl.className = 'alert alert-danger d-flex align-items-center';
                    messageEl.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${errorMessage}`;
                },
                complete: function() {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            });
        };

        // Enhanced form validation with per-date shift validation
        function validateForm() {
            // Clear any existing error messages
            document.querySelectorAll('.error-message').forEach(el => el.remove());
            let isValid = true;

            // Required field validation
            const requiredFields = [
                { id: 'EventName', name: 'Event Name', icon: 'bi-star' },
                { id: 'customerName', name: 'Customer Name', icon: 'bi-person' },
                { id: 'phoneNumber', name: 'Phone Number', icon: 'bi-telephone' },
                { id: 'fromDate', name: 'From Date', icon: 'bi-calendar-date' },
                { id: 'toDate', name: 'To Date', icon: 'bi-calendar-check' },
                { id: 'totalAmount', name: 'Total Amount', icon: 'bi-currency-rupee' }
            ];

            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (!element.value.trim()) {
                    const error = document.createElement('div');
                    error.className = 'error-message d-flex align-items-center';
                    error.innerHTML = `<i class="bi ${field.icon} me-2"></i>${field.name} is required`;
                    element.parentNode.insertBefore(error, element.nextSibling);
                    isValid = false;
                }
            });

            // Phone validation
            const phone = document.getElementById('phoneNumber').value.trim();
            if (phone && !/^\d{10}$/.test(phone)) {
                const error = document.createElement('div');
                error.className = 'error-message d-flex align-items-center';
                error.innerHTML = '<i class="bi bi-telephone-x me-2"></i>Please enter a valid 10-digit phone number';
                document.getElementById('phoneNumber').parentNode.appendChild(error);
                isValid = false;
            }

            // Date range validation
            const fromDate = new Date(document.getElementById('fromDate').value);
            const toDate = new Date(document.getElementById('toDate').value);
            if (fromDate && toDate && fromDate > toDate) {
                const error = document.createElement('div');
                error.className = 'error-message d-flex align-items-center';
                error.innerHTML = '<i class="bi bi-calendar-x me-2"></i>From date cannot be after to date';
                document.getElementById('toDate').parentNode.appendChild(error);
                isValid = false;
            }

            // Amount validation
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            const advanceAmount = parseFloat(document.getElementById('advancePayment').value) || 0;
            if (advanceAmount > totalAmount) {
                const error = document.createElement('div');
                error.className = 'error-message d-flex align-items-center';
                error.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Advance payment cannot exceed total amount';
                document.getElementById('advancePayment').parentNode.appendChild(error);
                isValid = false;
            }

            // ENHANCED SHIFT VALIDATION - Check each date individually
            const container = document.getElementById('dateWiseShiftContainer');
            const cards = container.querySelectorAll('.card'); // Each card represents one date

            if (cards.length === 0) {
                // No date cards generated - this shouldn't happen but let's handle it
                const error = document.createElement('div');
                error.className = 'error-message d-flex align-items-center mt-3';
                error.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Please select valid dates first';
                container.appendChild(error);
                isValid = false;
                return isValid;
            }

            // Validate each date card
            cards.forEach((card, cardIndex) => {
                // Get the date from card header
                const cardHeader = card.querySelector('.card-header h6');
                const dateText = cardHeader ? cardHeader.textContent.trim() : `Date ${cardIndex + 1}`;

                // Find all checkboxes within this specific card
                const checkboxesInCard = card.querySelectorAll('.shift-checkbox');
                const checkedBoxesInCard = card.querySelectorAll('.shift-checkbox:checked');

                console.log(`Validating card ${cardIndex + 1}: ${dateText}`);
                console.log(`Total checkboxes in card: ${checkboxesInCard.length}`);
                console.log(`Checked boxes in card: ${checkedBoxesInCard.length}`);

                // Check if at least one shift is selected for this date
                if (checkedBoxesInCard.length === 0) {
                    // Remove any existing error in this card first
                    card.querySelectorAll('.error-message').forEach(err => err.remove());

                    // Add error message to this specific card
                    const error = document.createElement('div');
                    error.className = 'error-message d-flex align-items-center mt-3 p-3 bg-danger bg-opacity-10 border border-danger rounded';
                    error.innerHTML = `
                        <i class="bi bi-exclamation-triangle-fill me-2 text-danger"></i>
                        <strong class="text-danger">Please select at least one shift for ${dateText}</strong>
                    `;

                    // Insert error at the end of card body
                    const cardBody = card.querySelector('.card-body');
                    if (cardBody) {
                        cardBody.appendChild(error);

                        // Scroll to this card to show the error
                        card.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }

                    isValid = false;
                } else {
                    // At least one shift is selected, now validate the time inputs for checked shifts
                    let hasTimeError = false;

                    checkedBoxesInCard.forEach(checkbox => {
                        const dateStr = checkbox.dataset.date;
                        const shiftType = checkbox.dataset.shift;

                        // Find the time inputs for this specific shift
                        const startInput = card.querySelector(`input[name="shift-${dateStr}-${shiftType}-start"]`);
                        const endInput = card.querySelector(`input[name="shift-${dateStr}-${shiftType}-end"]`);

                        console.log(`Checking times for ${shiftType} on ${dateStr}`);
                        console.log(`Start time: ${startInput?.value}, End time: ${endInput?.value}`);

                        if (!startInput?.value || !endInput?.value) {
                            if (!hasTimeError) {
                                // Remove any existing time errors in this card
                                card.querySelectorAll('.time-error-message').forEach(err => err.remove());

                                const error = document.createElement('div');
                                error.className = 'time-error-message error-message d-flex align-items-center mt-3 p-3 bg-warning bg-opacity-10 border border-warning rounded';
                                error.innerHTML = `
                                    <i class="bi bi-clock me-2 text-warning"></i>
                                    <strong class="text-warning">Please set start and end times for all selected shifts on ${dateText}</strong>
                                `;

                                const cardBody = card.querySelector('.card-body');
                                if (cardBody) {
                                    cardBody.appendChild(error);
                                }

                                hasTimeError = true;
                                isValid = false;
                            }
                        } else if (startInput.value >= endInput.value) {
                            if (!hasTimeError) {
                                // Remove any existing time errors in this card
                                card.querySelectorAll('.time-error-message').forEach(err => err.remove());

                                const error = document.createElement('div');
                                error.className = 'time-error-message error-message d-flex align-items-center mt-3 p-3 bg-warning bg-opacity-10 border border-warning rounded';
                                error.innerHTML = `
                                    <i class="bi bi-clock-history me-2 text-warning"></i>
                                    <strong class="text-warning">End time must be after start time for ${dateText}</strong>
                                `;

                                const cardBody = card.querySelector('.card-body');
                                if (cardBody) {
                                    cardBody.appendChild(error);
                                }

                                hasTimeError = true;
                                isValid = false;
                            }
                        }
                    });
                }
            });

            // Summary validation message
            if (!isValid) {
                // Show a summary toast message
                const checkedShiftsCount = container.querySelectorAll('.shift-checkbox:checked').length;
                const totalDates = cards.length;

                console.log(`Validation Summary: ${checkedShiftsCount} shifts selected across ${totalDates} dates`);

                // Scroll to the first error if validation fails
                const firstError = container.querySelector('.error-message');
                if (firstError) {
                    firstError.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }

            return isValid;
        }

        function openBookingModalForEdit(bookingData) {
            resetBookingForm();

            document.getElementById('modal-title-text').textContent = 'Edit Booking';
            document.getElementById('delete-booking').style.display = 'block';

            // Populate form fields
            document.getElementById('bookingId').value = bookingData.bookingId;
            document.getElementById('EventName').value = bookingData.eventName || '';
            document.getElementById('customerName').value = bookingData.customerName || '';
            document.getElementById('phoneNumber').value = bookingData.phoneNumber || '';
            document.getElementById('alternativeNumber').value = bookingData.alternativeNumber || '';
            document.getElementById('fromDate').value = bookingData.fromDate ? bookingData.fromDate.split('T')[0] : '';
            document.getElementById('toDate').value = bookingData.toDate ? bookingData.toDate.split('T')[0] : '';
            document.getElementById('bookingStatus').value = bookingData.bookingStatus || 'Confirmed';
            document.getElementById('paymentStatus').value = bookingData.paymentStatus || 'Pending';
            document.getElementById('totalAmount').value = bookingData.totalAmount || '';
            document.getElementById('advancePayment').value = bookingData.advancePayment || '';
            document.getElementById('address').value = bookingData.address || '';
            document.getElementById('bandType').value = bookingData.bandType || '';
            document.getElementById('diesel').value = bookingData.diesel || '';

            calculateRemainingPayment();

            // Generate date-wise shifts first
            generateDateWiseShifts(bookingData.bookingId, bookingData.shiftDetailsArray);

            // Then populate existing shift times if available
            setTimeout(() => {
                populateExistingShiftTimes(bookingData);
            }, 100);

            bookingModal.show();
        }

        function populateExistingShiftTimes(bookingData) {
            if (bookingData.dateWiseShifts) {
                try {
                    const existingShifts = JSON.parse(bookingData.dateWiseShifts);

                    Object.keys(existingShifts).forEach(dateStr => {
                        const dayShifts = existingShifts[dateStr];

                        dayShifts.forEach(shiftData => {
                            const shiftType = shiftData.shift;

                            // 1. Check the shift checkbox
                            const checkbox = document.getElementById(`checkbox-${shiftType}-${dateStr}`);
                            if (checkbox) {
                                checkbox.checked = true;

                                // 2. Show the shift time section
                                const timesContainer = document.getElementById(`${shiftType}-times-${dateStr}`);
                                if (timesContainer) {
                                    timesContainer.style.display = 'block';
                                }

                                // 3. Fill in start/end times
                                const startInput = document.querySelector(`input[name="shift-${dateStr}-${shiftType}-start"]`);
                                const endInput = document.querySelector(`input[name="shift-${dateStr}-${shiftType}-end"]`);

                                if (startInput && shiftData.startTime) {
                                    startInput.value = shiftData.startTime;
                                }
                                if (endInput && shiftData.endTime) {
                                    endInput.value = shiftData.endTime;
                                }
                            }
                        });
                    });
                } catch (error) {
                    console.error('Error parsing shift times:', error);
                }
            }
        }

        function sendWhatsAppMessage(booking) {
            const phone = booking.phoneNumber?.replace(/\D/g, '');
            if (!phone) {
                showToast('❌ No phone number available', 'error');
                return;
            }

            const eventName = booking.eventName || 'your event';
            const customerName = booking.customerName || 'Customer';
            const eventDate = formatDate(booking.fromDate);
            const shiftType = capitalizeFirstLetter(booking.shiftType);
            const totalAmount = (booking.totalAmount || 0).toLocaleString();
            const balance = (booking.remainingPayment || 0).toLocaleString();

            let message = `🎉 Hello ${customerName}!\n\n`;
            message += `Your booking for "${eventName}" has been confirmed! ✅\n\n`;
            message += `📅 Date: ${eventDate}\n`;
            message += `⏰ Shift: ${shiftType}\n`;
            message += `💰 Total Amount: ₹${totalAmount}\n`;

            if (booking.remainingPayment > 0) {
                message += `💳 Balance Due: ₹${balance}\n`;
            }

            message += `\nThank you for choosing our services! 🙏\n`;
            message += `For any queries, feel free to contact us.`;

            const url = `https://wa.me/91${phone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            showToast('📱 Opening WhatsApp...', 'success');
        }

        window.openWhatsApp = function() {
            const phone = document.getElementById('phoneNumber').value.replace(/\D/g, '');
            if (!phone) {
                showToast('📱 Please enter phone number first', 'error');
                return;
            }

            const url = `https://wa.me/91${phone}`;
            window.open(url, '_blank');
            showToast('📱 Opening WhatsApp...', 'success');
        };

        // Date change listeners will regenerate shifts when dates change
        document.getElementById('fromDate').addEventListener('change', generateDateWiseShifts);
        document.getElementById('toDate').addEventListener('change', generateDateWiseShifts);

        function generateDateWiseShifts(editBookingId = null, editBookingData = []) {
            const fromDateInput = document.getElementById('fromDate');
            const toDateInput = document.getElementById('toDate');
            const container = document.getElementById('dateWiseShiftContainer');

            const fromDate = new Date(fromDateInput.value);
            const toDate = new Date(toDateInput.value);

            if (isNaN(fromDate) || isNaN(toDate)) {
                container.innerHTML = '';
                return;
            }

            if (fromDate > toDate) {
                container.innerHTML = `
                    <div class="alert alert-warning d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Please select a valid date range
                    </div>
                `;
                return;
            }

            let html = `
                <div class="alert alert-primary mb-3">
                    <i class="bi bi-calendar-check me-2"></i>
                    <strong>Select your preferred shifts and set times:</strong>
                </div>
            `;

            let dayCount = 0;
            for (let d = new Date(fromDate); d <= toDate; d.setDate(d.getDate() + 1)) {
                dayCount++;
                if (dayCount > 31) break;

                const dateStr = localYMD(d);
                const allShifts = shiftMap[dateStr] || [];

                const editableShifts = editBookingData.filter(b => b.date === dateStr).map(b => b.shift);
                const shiftTimeMap = {};
                editBookingData.forEach(entry => {
                    if (entry.date === dateStr) {
                        shiftTimeMap[entry.shift] = {
                            start: entry.startTime,
                            end: entry.endTime
                        };
                    }
                });

                const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });

                const shiftTemplate = (shiftType, icon, label, colorClass) => {
                    // Only consider shifts from OTHER bookings (exclude current booking being edited)
                    const shiftBookedByOthers = allShifts.find(s =>
                        s.shift === shiftType &&
                        (!editBookingId || s.fullBookingData.bookingId !== parseInt(editBookingId))
                    );

                    const isDisabled = !!shiftBookedByOthers;
                    const isChecked = editableShifts.includes(shiftType);
                    const times = shiftTimeMap[shiftType] || { start: '', end: '' };

                    const inputId = `checkbox-${shiftType}-${dateStr}`;

                    let labelMessage = '<small class="text-muted">Available</small>';
                    if (isDisabled) {
                        const bookedByName = shiftBookedByOthers.fullBookingData.customerName || 'Another customer';
                        labelMessage = `<small class="text-danger">⚠️ Booked by ${bookedByName}</small>`;
                    } else if (isChecked) {
                        labelMessage = '<small class="text-success">✅ Selected for this booking</small>';
                    }

                    return {
                        checkboxHTML: `
                            <div class="col-md-6">
                                <label class="d-flex align-items-center p-3 border rounded cursor-pointer ${isDisabled ? 'bg-light opacity-50' : isChecked ? 'bg-success bg-opacity-10 border-success' : 'bg-white'}"
                                       for="${inputId}">
                                    <input type="checkbox"
                                           id="${inputId}"
                                           class="form-check-input me-3 shift-checkbox"
                                           data-date="${dateStr}"
                                           data-shift="${shiftType}"
                                           ${isDisabled ? 'disabled' : ''}
                                           ${isChecked && !isDisabled ? 'checked' : ''}
                                           style="transform: scale(1.5);">
                                    <div>
                                        <div class="fw-bold ${colorClass}">
                                            <i class="bi ${icon} me-2"></i>${label}
                                        </div>
                                        ${labelMessage}
                                    </div>
                                </label>
                            </div>
                        `,
                        timesHTML: `
                            <div id="${shiftType}-times-${dateStr}" class="shift-times-section" style="display: ${isChecked && !isDisabled ? 'block' : 'none'};">
                                <div class="alert alert-${shiftType === 'morning' ? 'warning' : 'info'}">
                                    <h6 class="alert-heading">
                                        <i class="bi ${icon} me-2"></i>${label} Configuration
                                    </h6>
                                    <div class="row g-3">
                                        <div class="col-6">
                                            <label class="form-label fw-bold">Start Time</label>
                                            <input type="time"
                                                   class="form-control form-control-lg"
                                                   name="shift-${dateStr}-${shiftType}-start"
                                                   value="${times.start || (shiftType === 'morning' ? '09:00' : '17:00')}"
                                                   required>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label fw-bold">End Time</label>
                                            <input type="time"
                                                   class="form-control form-control-lg"
                                                   name="shift-${dateStr}-${shiftType}-end"
                                                   value="${times.end || (shiftType === 'morning' ? '13:00' : '21:00')}"
                                                   required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `
                    };
                };

                const morning = shiftTemplate('morning', 'bi-sunrise', 'Morning Shift', 'text-warning');
                const evening = shiftTemplate('evening', 'bi-sunset', 'Evening Shift', 'text-info');

                html += `
                    <div class="card mb-4 shadow-sm" data-date="${dateStr}">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-calendar-event me-2"></i>
                                ${formatDate(dateStr)} - ${dayName}
                            </h6>
                        </div>
                        <div class="card-body">

                            <div class="mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-check-square me-2"></i>Choose your shifts:
                                </h6>
                                <div class="row g-3">
                                    ${morning.checkboxHTML}
                                    ${evening.checkboxHTML}
                                </div>
                            </div>

                            ${morning.timesHTML}
                            ${evening.timesHTML}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
            addShiftCheckboxListeners();
        }

        function addShiftCheckboxListeners() {
            // Find all checkboxes with class 'shift-checkbox'
            const allCheckboxes = document.querySelectorAll('.shift-checkbox');
            console.log('Found checkboxes:', allCheckboxes.length);

            allCheckboxes.forEach((checkbox, index) => {
                console.log(`Setting up checkbox ${index}:`, checkbox.id);

                // Add change event listener to each checkbox
                checkbox.addEventListener('change', function() {
                    const dateStr = this.getAttribute('data-date');
                    const shiftType = this.getAttribute('data-shift');
                    const timesContainer = document.getElementById(`${shiftType}-times-${dateStr}`);

                    console.log(`Checkbox changed: ${shiftType} for ${dateStr}, checked: ${this.checked}`);

                    if (this.checked) {
                        // SHOW time configuration when checked
                        if (timesContainer) {
                            timesContainer.style.display = 'block';
                            timesContainer.style.animation = 'fadeInUp 0.3s ease-out';
                        }
                    } else {
                        // HIDE time configuration when unchecked
                        if (timesContainer) {
                            timesContainer.style.display = 'none';

                            // Clear the time values
                            const startInput = timesContainer.querySelector(`input[name="shift-${dateStr}-${shiftType}-start"]`);
                            const endInput = timesContainer.querySelector(`input[name="shift-${dateStr}-${shiftType}-end"]`);
                            if (startInput) startInput.value = '';
                            if (endInput) endInput.value = '';
                        }
                    }
                });
            });
        }

        // Enhanced event handlers
        document.getElementById('advancePayment').addEventListener('input', calculateRemainingPayment);
        document.getElementById('totalAmount').addEventListener('input', calculateRemainingPayment);

        // Enhanced delete with cache invalidation
        document.getElementById('delete-booking').addEventListener('click', function() {
            const bookingId = document.getElementById('bookingId').value;
            if (!bookingId) return;

            const eventName = document.getElementById('EventName').value || 'this booking';
            const confirmMessage = `Are you sure you want to delete "${eventName}"?\n\nThis action cannot be undone.`;

            if (!confirm(confirmMessage)) return;

            const deleteBtn = this;
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Deleting...';
            deleteBtn.disabled = true;

            $.ajax({
                url: `/EventBooking/Delete/${bookingId}`,
                type: 'POST',
                timeout: 10000,
                success: function(response) {
                    if (response.success) {
                        showToast('🗑️ Booking deleted successfully', 'success');
                        bookingModal.hide();

                        // OPTIMIZED: Invalidate cache and reload once
                        invalidateCache();
                        loadEvents(true);
                    } else {
                        showToast('❌ Failed to delete booking', 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Delete booking error:', error);
                    let errorMessage = 'Failed to delete booking';
                    if (status === 'timeout') {
                        errorMessage = 'Request timeout - please try again';
                    }
                    showToast(`❌ ${errorMessage}`, 'error');
                },
                complete: function() {
                    deleteBtn.innerHTML = originalText;
                    deleteBtn.disabled = false;
                }
            });
        });

        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveBooking();
        });

        // Enhanced real-time validation
        function addRealTimeValidation() {
            // Add real-time validation for shift selection
            const container = document.getElementById('dateWiseShiftContainer');

            // Use event delegation for dynamically added checkboxes
            container.addEventListener('change', function(e) {
                if (e.target.classList.contains('shift-checkbox')) {
                    const card = e.target.closest('.card');
                    if (card) {
                        // Remove previous validation errors for this card
                        card.querySelectorAll('.error-message').forEach(err => err.remove());

                        // Check if at least one checkbox is checked in this card
                        const checkedInCard = card.querySelectorAll('.shift-checkbox:checked');

                        if (checkedInCard.length > 0) {
                            // At least one shift selected - remove any "no shift selected" errors
                            card.querySelectorAll('.error-message').forEach(err => {
                                if (err.textContent.includes('select at least one shift')) {
                                    err.remove();
                                }
                            });
                        }
                    }
                }
            });

            // Real-time validation for time inputs
            container.addEventListener('blur', function(e) {
                if (e.target.type === 'time') {
                    const card = e.target.closest('.card');
                    if (card) {
                        // Remove previous time validation errors
                        card.querySelectorAll('.time-error-message').forEach(err => err.remove());

                        // Validate time pairs in this card
                        const checkedBoxes = card.querySelectorAll('.shift-checkbox:checked');
                        checkedBoxes.forEach(checkbox => {
                            const dateStr = checkbox.dataset.date;
                            const shiftType = checkbox.dataset.shift;

                            const startInput = card.querySelector(`input[name="shift-${dateStr}-${shiftType}-start"]`);
                            const endInput = card.querySelector(`input[name="shift-${dateStr}-${shiftType}-end"]`);

                            if (startInput?.value && endInput?.value && startInput.value >= endInput.value) {
                                const error = document.createElement('div');
                                error.className = 'time-error-message error-message d-flex align-items-center mt-2 text-warning';
                                error.innerHTML = '<i class="bi bi-clock-history me-2"></i>End time must be after start time';
                                endInput.parentNode.appendChild(error);
                            }
                        });
                    }
                }
            }, true);
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @@keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @@keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }

            @@keyframes fadeInUp {
                from {
                    transform: translateY(30px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            .detail-card {
                animation: fadeInUp 0.3s ease-out;
            }
        `;
        document.head.appendChild(style);

        // Initialize calendar when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add loading animation to body
            document.body.style.opacity = '0';
            document.body.style.transition = 'opacity 0.3s ease-in-out';

            setTimeout(() => {
                initializeCalendar();
                addRealTimeValidation();
                document.body.style.opacity = '1';
                showToast('🎉 Event Booking Pro loaded successfully!', 'success');
            }, 100);
        });


        // Enhanced keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + N to open new booking
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                openBookingModal();
            }

            // Ctrl/Cmd + R to refresh calendar
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                refreshCalendar();
            }

            // Escape to close modals
            if (e.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal.show');
                openModals.forEach(modal => {
                    bootstrap.Modal.getInstance(modal)?.hide();
                });
            }
        });

        // Clear cache on page unload
        window.addEventListener('beforeunload', function() {
            invalidateCache();
        });

        // Add service worker for offline support (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Register service worker if available
                // This would need to be implemented separately
                console.log('Service Worker support detected');
            });
        }
</script>
</body>
</html>